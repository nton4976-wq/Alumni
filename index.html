<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alumni Management</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader" class="loader" style="display:none;">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--text-main);">Loading Alumni Data...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header>
            <div class="brand">
                <div class="brand-icon"><i class="fa-solid fa-graduation-cap"></i></div>
                <div>
                    <h1>RSU Alumni</h1>
                    <span>Management Directory System</span>
                </div>
            </div>

            <div style="display:flex; gap:0.75rem; align-items:center;">
                <!-- sheetSelect already exists and is used as currentSheet selector -->
                <select id="sheetSelect" class="active" style="font-weight:700;">
                    <option value="2025">Batch 2025</option>
                    <option value="2024">Batch 2024</option>
                    <option value="2023">Batch 2023</option>
                </select>

                <!-- export button (id matches JS) -->
                <button id="exportBtnTop" class="btn-primary">
                    <i class="fa-solid fa-download"></i> Export CSV
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fa-solid fa-users"></i></div>
                <div class="stat-info"><h3 id="stat-total">0</h3><p>Total Graduates</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fa-solid fa-user-check"></i></div>
                <div class="stat-info"><h3 id="stat-complete">0</h3><p>Profiles Complete</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fa-solid fa-mars"></i></div>
                <div class="stat-info"><h3 id="stat-male">0</h3><p>Male Alumni</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fa-solid fa-venus"></i></div>
                <div class="stat-info"><h3 id="stat-female">0</h3><p>Female Alumni</p></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <div class="filter-group">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search name, email, course...">
                </div>

                <!-- Batch select hidden as requested -->
                <select id="batchSelect" style="display:none;">
                    <option value="">Select Batch</option>
                </select>

                <select id="collegeSelect">
                    <option value="">All Colleges</option>
                </select>

                <select id="courseSelect" style="display:none;">
                    <option value="">All Courses</option>
                </select>
            </div>

            <div style="display:flex; align-items:center; gap:0.5rem;">
                <!-- Status dropdown: All / Complete / Incomplete -->
                <select id="statusFilter" style="font-weight:700;">
                    <option value="">All Status</option>
                    <option value="complete">Complete</option>
                    <option value="incomplete">Incomplete</option>
                </select>

                <!-- municipality & birthmonth as buttons that show selected -->
                <button id="btn-municipality" class="btn-option" title="Municipality">Municipality</button>
                <button id="btn-birthmonth" class="btn-option" title="Birth Month">Birth Month</button>

                <!-- undo/reset -->
                <button class="btn-icon" id="btn-reset" title="Reset Filters"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <!-- Alphabet -->
        <div class="alphabet-filter" id="alphabetContainer"></div>

        <!-- Grid -->
        <div class="cards-grid" id="cardsContainer"></div>
    </div>

    <!-- Generic Option Modal -->
    <div class="modal-overlay" id="optionModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select Option</h3>
                <button class="modal-close" onclick="closeModalAll()">&times;</button>
            </div>
            <p id="optionModalDesc" style="color:var(--text-muted); margin-bottom:0.5rem;">Choose an option:</p>
            <div id="optionFallback" style="display:none; color:#a00; padding:0.6rem;">No options available</div>
            <div class="option-list" id="optionList"></div>
        </div>
    </div>

    <!-- Hidden selects referenced by JS (municipality, birthmonth) -->
    <select id="municipalitySelect" style="display:none;"><option value="">Select Municipality</option></select>
    <select id="birthmonthSelect" style="display:none;"><option value="">Select Birthmonth</option></select>

    <!-- Small placeholders for potentially referenced elements in script -->
    <div id="courseModal" style="display:none;"></div>
    <div id="courseList" style="display:none;"></div>
    <div id="courseFallback" style="display:none;"></div>
    <button id="optionClearBtn" style="display:none;"></button>

    <script>
    /* ====== CONFIG ====== */
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby9v4ZZtrFj9KIDMM4SI5Psh1jDZqH0tqQxZpL-HewQ65Bb6HjOM_x9DzRhoJSuYFsz/exec';

    /* ---------- Helpers ---------- */
    function normalizeKey(s){ return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,''); }
    function safeLower(v){ return String(v || '').toLowerCase(); }
    function uid(){ return 'u_' + Date.now() + '_' + Math.floor(Math.random()*10000); }
    function isBlankOrNA(value){ if(value === null || value === undefined) return true; const s = String(value).trim(); return s === '' || /^(-|n\/a|na)$/i.test(s); }
    const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    function monthNumberFromAny(v){
      if(v === null || v === undefined) return null;
      if(typeof v === 'number' && !isNaN(v) && v >= 1 && v <= 12) return v;
      const s = String(v).trim();
      if(s === '') return null;
      if(/^\d{1,2}$/.test(s)){
        const n = parseInt(s,10);
        if(n >=1 && n <= 12) return n;
      }
      const parsed = Date.parse(s);
      if(!isNaN(parsed)){
        const d = new Date(parsed);
        return d.getMonth() + 1;
      }
      const monthRegex = /(jan(uary)?|feb(ruary)?|mar(ch)?|apr(il)?|may|jun(e)?|jul(y)?|aug(ust)?|sep(t)?(ember)?|oct(ober)?|nov(ember)?|dec(ember)?)/i;
      const m = s.match(monthRegex);
      if(m){
        const found = m[0].toLowerCase();
        for(let i=0;i<MONTH_NAMES.length;i++){
          if(MONTH_NAMES[i].toLowerCase().startsWith(found)) return i+1;
        }
      }
      return null;
    }
    function monthNameFromNumber(num){ const n = parseInt(num,10); if(isNaN(n) || n<1 || n>12) return ''; return MONTH_NAMES[n-1]; }
    function formatBirthday(v){
      if(!v) return '';
      let d = null;
      if(typeof v === 'number') d = new Date(v);
      if(typeof v === 'string'){
        const s = v.trim();
        const iso = Date.parse(s);
        if(!isNaN(iso)) d = new Date(iso);
        else {
          const parts1 = s.split(/[\/\-\.\s]+/).map(p=>p.trim());
          if(parts1.length === 3){
            if(parts1[0].length === 4){
              const y = parseInt(parts1[0],10), m = parseInt(parts1[1],10)-1, day = parseInt(parts1[2],10);
              d = new Date(y,m,day);
            } else {
              const a = new Date(parseInt(parts1[2],10), parseInt(parts1[0],10)-1, parseInt(parts1[1],10));
              if(!isNaN(a)) d = a;
              else {
                const b = new Date(parseInt(parts1[2],10), parseInt(parts1[1],10)-1, parseInt(parts1[0],10));
                if(!isNaN(b)) d = b;
              }
            }
          }
        }
      }
      if(!d || isNaN(d)) return String(v);
      const m = MONTH_NAMES[d.getMonth()];
      const day = d.getDate();
      const year = d.getFullYear();
      return `${m} ${day}, ${year}`;
    }
    function parseDateFromAny(v){
      if(!v) return null;
      if(v instanceof Date && !isNaN(v)) return v;
      if(typeof v === 'number'){ const d=new Date(v); if(!isNaN(d)) return d; return null; }
      const s = String(v).trim();
      if(s==='') return null;
      const iso = Date.parse(s);
      if(!isNaN(iso)) return new Date(iso);
      const parts = s.split(/[\/\-\.\s]+/).map(p=>p.trim());
      if(parts.length===3){
        if(parts[0].length===4){
          const y=parseInt(parts[0],10), m=parseInt(parts[1],10)-1, day=parseInt(parts[2],10);
          const d = new Date(y,m,day); if(!isNaN(d)) return d;
        }
        let d1 = new Date(parseInt(parts[2],10), parseInt(parts[0],10)-1, parseInt(parts[1],10)); if(!isNaN(d1)) return d1;
        let d2 = new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10)); if(!isNaN(d2)) return d2;
      }
      return null;
    }
    function computeAgeFromBirthday(bday){
      if(!bday) return null;
      const d = parseDateFromAny(bday);
      if(!d) return null;
      const now = new Date();
      let age = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
      return age >= 0 ? age : null;
    }
    function computeCompleteStatus(person){
      const hasMiddle = !isBlankOrNA(person.middlename);
      const hasEmail = !isBlankOrNA(person.email);
      const hasPhone = !isBlankOrNA(person.cpnumber);
      if(hasMiddle && hasEmail && hasPhone) return 'complete';
      return 'incomplete';
    }

    /* ---------- DOM refs (aligned with markup) ---------- */
    const cardsContainer = document.getElementById('cardsContainer');
    const searchInput = document.getElementById('searchInput');
    const alphabetContainer = document.getElementById('alphabetContainer');
    const batchSelect = document.getElementById('batchSelect');
    const collegeSelect = document.getElementById('collegeSelect');
    const courseSelect = document.getElementById('courseSelect');
    const municipalitySelect = document.getElementById('municipalitySelect');
    const birthmonthSelect = document.getElementById('birthmonthSelect');
    const statusFilter = document.getElementById('statusFilter');

    const exportBtnTop = document.getElementById('exportBtnTop');
    const sheetSelect = document.getElementById('sheetSelect');
    const loadingOverlay = document.getElementById('loader');

    const optionModal = document.getElementById('optionModal');
    const optionListEl = document.getElementById('optionList');
    const optionModalTitle = document.getElementById('modalTitle');
    const optionModalDesc = document.getElementById('optionModalDesc');
    const optionFallback = document.getElementById('optionFallback');

    const btnMunicipality = document.getElementById('btn-municipality');
    const btnBirthmonth = document.getElementById('btn-birthmonth');
    const btnReset = document.getElementById('btn-reset');

    let allData = [];
    let filteredData = [];
    let selectedLetter = '';
    let collegeCourseMap = {};
    let currentSheet = '2025';

    /* ---------- Loading overlay helpers ---------- */
    function showLoading(){
      if(sheetSelect) sheetSelect.disabled = true;
      if(exportBtnTop) exportBtnTop.disabled = true;
      if(collegeSelect){ collegeSelect.innerHTML = '<option>Loading...</option>'; collegeSelect.disabled = true; }
      if(batchSelect){ batchSelect.innerHTML = '<option>Loading...</option>'; batchSelect.disabled = true; }
      if(courseSelect){ courseSelect.innerHTML = '<option>Loading...</option>'; courseSelect.disabled = true; }
      if(municipalitySelect){ municipalitySelect.innerHTML = '<option>Loading...</option>'; municipalitySelect.disabled = true; }
      if(birthmonthSelect){ birthmonthSelect.innerHTML = '<option>Loading...</option>'; birthmonthSelect.disabled = true; }
      if(loadingOverlay) loadingOverlay.style.display = 'flex';
    }
    function hideLoading(){
      if(sheetSelect) sheetSelect.disabled = false;
      if(exportBtnTop) exportBtnTop.disabled = false;
      if(collegeSelect){ collegeSelect.disabled = false; }
      if(batchSelect){ batchSelect.disabled = false; }
      if(courseSelect){ courseSelect.disabled = false; }
      if(municipalitySelect){ municipalitySelect.disabled = false; }
      if(birthmonthSelect){ birthmonthSelect.disabled = false; }
      if(loadingOverlay) loadingOverlay.style.display = 'none';
    }

    /* ---------- Server interaction (unchanged) ---------- */
    async function fetchAllFromServer(sheetName){
      const sheetParam = sheetName ? `?sheet=${encodeURIComponent(sheetName)}` : '';
      const url = WEBAPP_URL + sheetParam;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Failed to fetch from server: ' + res.statusText);
      const data = await res.json();
      if(!Array.isArray(data)) {
        if(data && data.error) throw new Error(data.error);
        throw new Error('Unexpected response from server');
      }
      return data.map((r, idx) => {
        const rownum = r._row || r.row || r.rowNumber || r.rowNum;
        if(!r._uid) r._uid = r.id ? String(r.id) : uid();
        r._row = rownum;
        r.firstname = r.firstname || r.firstName || r.first || '';
        r.middlename = r.middlename || r.middleName || r.middle || '';
        r.surname = r.surname || r.lastName || r.last || '';
        r.cpnumber = r.cpnumber || r.phone || r.mobile || '';
        r.email = r.email || r.Email || '';
        r.college = r.college || r.campus || '';
        r.course = r.course || '';
        r.batch = r.batch || '';
        r.designation = r.designation || r.position || '';
        r.job = r.job || r.designation || '';
        r.address = r.address || r.Address || '';
        r.gender = r.gender || '';
        const rawMunicipality = r.municipality || r.munic || r.city || r.town || r.muni || '';
        r.municipalityRaw = rawMunicipality;
        r.municipality = rawMunicipality;
        r.birthday = r.birthday || r.birthdate || r.dob || '';
        let rawBM = (r.birthmonth !== undefined && r.birthmonth !== null) ? r.birthmonth : '';
        r.birthmonthRaw = rawBM;
        const bmNumFromField = monthNumberFromAny(rawBM);
        if(bmNumFromField){
          r.birthmonthNum = bmNumFromField;
          r.birthmonth = monthNameFromNumber(bmNumFromField);
        } else {
          const bmNumFromBirthday = monthNumberFromAny(r.birthday);
          if(bmNumFromBirthday){
            r.birthmonthNum = bmNumFromBirthday;
            r.birthmonth = monthNameFromNumber(bmNumFromBirthday);
          } else {
            r.birthmonthNum = null;
            r.birthmonth = rawBM ? String(rawBM).trim() : '';
          }
        }
        r.complete = computeCompleteStatus(r);
        const hasRealPerson = !isBlankOrNA(r.firstname) || !isBlankOrNA(r.surname) || !isBlankOrNA(r.email);
        if(!hasRealPerson) return null;
        return r;
      }).filter(Boolean);
    }

    async function updateOnServer(row, data){
      const sheetParam = currentSheet ? `?sheet=${encodeURIComponent(currentSheet)}` : '';
      const url = WEBAPP_URL + sheetParam;
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action:'update', row: row, data })
      });
      return res.json();
    }

    /* ---------- Sorting / rendering helpers ---------- */
    function compareNames(a, b){
      const as = safeLower(a.surname || '');
      const bs = safeLower(b.surname || '');
      const af = safeLower(a.firstname || '');
      const bf = safeLower(b.firstname || '');
      if(as === '' && bs !== '') return 1;
      if(as !== '' && bs === '') return -1;
      if(as < bs) return -1;
      if(as > bs) return 1;
      if(af < bf) return -1;
      if(af > bf) return 1;
      return 0;
    }

    function initialsFor(p){
      const surname = !isBlankOrNA(p.surname) ? p.surname : '';
      const firstname = !isBlankOrNA(p.firstname) ? p.firstname : '';
      const s = surname ? surname.charAt(0).toUpperCase() : '';
      let f = '';
      if(firstname){
        const firstWord = firstname.split(/\s+/)[0] || '';
        f = firstWord ? firstWord.charAt(0).toUpperCase() : '';
      }
      if(s && f) return s + f;
      if(s) return s;
      if(f) return f;
      return (p.firstname ? p.firstname.charAt(0).toUpperCase() : 'A');
    }

    function renderCard(p){
      const hasAny = !(
        isBlankOrNA(p.firstname) &&
        isBlankOrNA(p.middlename) &&
        isBlankOrNA(p.surname) &&
        isBlankOrNA(p.email) &&
        isBlankOrNA(p.cpnumber) &&
        isBlankOrNA(p.address) &&
        isBlankOrNA(p.gender) &&
        isBlankOrNA(p.course) &&
        isBlankOrNA(p.college) &&
        isBlankOrNA(p.batch)
      );
      if(!hasAny) return '';

      const surname = isBlankOrNA(p.surname) ? '' : p.surname;
      const firstname = isBlankOrNA(p.firstname) ? '' : p.firstname;
      const middlename = isBlankOrNA(p.middlename) ? '' : p.middlename;
      const displayName = surname ? `${surname}, ${firstname}${middlename ? ' ' + middlename : ''}` : `${firstname} ${middlename}`.trim() || 'Unknown';
      const completeClass = computeCompleteStatus(p) === 'complete' ? 'complete' : 'incomplete';
      const gender = p.gender || 'Not specified';
      const address = p.address || (p.municipality || 'No address provided');
      const cp = p.cpnumber || 'No contact number';
      const email = p.email || 'No email';
      const age = computeAgeFromBirthday(p.birthday);
      const initials = initialsFor(p);

      // Build front/back with flip-ready markup (front now includes overlapping avatar + left-aligned name)
      return `
        <div class="card" data-uid="${p._uid}" data-row="${p._row || ''}"
             data-surname="${safeLower(surname)}" data-gender="${safeLower(gender)}" data-batch="${safeLower(p.batch||'') }"
             data-college="${safeLower(p.college||'')}" data-course="${safeLower(p.course||'')}" data-complete="${safeLower(computeCompleteStatus(p))}"
             data-email="${String(email).replace(/"/g,'&quot;')}" data-phone="${String(cp).replace(/"/g,'&quot;')}" data-college-display="${p.college || ''}" data-course-display="${p.course || ''}"
             data-position="${p.designation || ''}" data-address="${address}" data-job="${p.job || ''}" data-birthday="${(p.birthday || '')}">
          <div class="card-inner">
            <div class="card-face card-front">
              <div class="card-header"></div>

              <!-- overlapping initials avatar -->
              <div class="avatar">${initials}</div>

              <div class="card-body">
                <h3>${displayName}</h3>
                <div class="role">${p.course || ''}${p.college ? ' — ' + p.college : ''}</div>

                <div class="info">
                  ${address ? `<p><i class="fa-solid fa-location-dot"></i><small>${address}</small></p>` : ''}
                  ${cp ? `<p><i class="fa-solid fa-phone"></i><small>${cp}</small></p>` : ''}
                  ${email ? `<p><i class="fa-solid fa-envelope"></i><small>${email}</small></p>` : ''}
                </div>
              </div>

              <div class="card-footer">
                <div class="status-indicator ${completeClass}">${completeClass === 'complete' ? 'Complete' : 'Incomplete'}</div>
                <button type="button" class="view"><i class="fa-solid fa-eye"></i> View</button>
              </div>
            </div>

            <div class="card-face card-back">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:800;">Details</div>
                <button class="view" style="border-radius:8px;padding:0.4rem 0.6rem;font-weight:700;">Back</button>
              </div>

              <div class="back-grid">
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Batch</div><div>${p.batch || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Birthday</div><div>${formatBirthday(p.birthday) || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Age</div><div>${age !== null ? age : '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Gender</div><div>${p.gender || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Position</div><div>${p.designation || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Job</div><div>${p.job || '—'}</div></div>
              </div>

              <div style="margin-top:auto; padding-top:0.75rem;">
                <div style="font-size:0.8rem; color:var(--text-muted);">Tap <strong>Back</strong> or the eye button to return.</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCards(dataArray){
      if(!cardsContainer) return;
      cardsContainer.innerHTML = '';
      if(!Array.isArray(dataArray) || dataArray.length === 0){
        cardsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-folder-open" style="font-size:3rem; opacity:0.6;"></i>
            <div class="empty-title" style="font-weight:800; margin-top:0.5rem;">No Data Available</div>
            <div class="empty-sub" style="opacity:0.8;">No alumni records match your current filter or search.</div>
          </div>
        `;
        const statsEl = document.querySelector('.stats-grid');
        if(statsEl) statsEl.style.opacity = "0.45";
        updateStats([]);
        return;
      }
      const statsEl = document.querySelector('.stats-grid');
      if(statsEl) statsEl.style.opacity = "1";
      cardsContainer.innerHTML = dataArray.map(renderCard).join('');
      attachCardListeners();
      updateStats(filteredData);
    }

    function updateStats(displayArray){
      const dataArray = Array.isArray(displayArray) ? displayArray : (filteredData || []);
      const total = dataArray.length;
      const male = dataArray.filter(d => safeLower(d.gender || '').startsWith('m')).length;
      const female = dataArray.filter(d => safeLower(d.gender || '').startsWith('f')).length;
      const completeCount = dataArray.filter(d => computeCompleteStatus(d) === 'complete').length;
      const incompleteCount = dataArray.filter(d => computeCompleteStatus(d) === 'incomplete').length;

      const statTotal = document.querySelector('#stat-total');
      const statComplete = document.querySelector('#stat-complete');
      const statMale = document.querySelector('#stat-male');
      const statFemale = document.querySelector('#stat-female');

      if(statTotal) statTotal.innerText = total;
      if(statComplete) statComplete.innerText = `${completeCount} / ${incompleteCount}`;
      if(statMale) statMale.innerText = male;
      if(statFemale) statFemale.innerText = female;
    }

    /* ---------- Card listeners (flip behavior, no message or status clicks) ---------- */
    function attachCardListeners(){
      // View / Back buttons flip
      document.querySelectorAll('.card .view').forEach(btn=>{
        btn.onclick = (e)=>{
          const cardRoot = btn.closest('.card');
          if(!cardRoot) return;
          cardRoot.classList.toggle('flipped');
        };
      });
    }

    /* ---------- Modals ---------- */
    function openModal(id){
      const m = document.getElementById(id);
      if(!m) return;
      m.style.display = 'flex';
      m.classList.add('active');
      m.setAttribute('aria-hidden','false');
    }

    function closeModalAll(){
      document.querySelectorAll('.modal-overlay').forEach(m => {
        m.style.display = 'none';
        m.classList.remove('active');
        m.setAttribute('aria-hidden','true');
      });
    }

    document.addEventListener('click', function(e){
      if(e.target.classList && e.target.classList.contains('modal-close')) { closeModalAll(); return; }
      if(e.target.classList && e.target.classList.contains('modal-overlay')) { closeModalAll(); return; }
    });

    /* ---------- Filtering ---------- */
    function applyFilters(){
      const qRaw = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
      const q = safeLower(qRaw);
      const batchV = batchSelect ? safeLower(batchSelect.value || '') : '';
      const collegeV = collegeSelect ? safeLower(collegeSelect.value || '') : '';
      const courseV = courseSelect ? safeLower(courseSelect.value || '') : '';
      const municipalityV = municipalitySelect ? safeLower(municipalitySelect.value || '') : '';
      const birthmonthV = birthmonthSelect ? String(birthmonthSelect.value) : '';
      const statusV = statusFilter ? safeLower(statusFilter.value || '') : '';

      filteredData = allData.filter(p=>{
        const first = safeLower(p.firstname || '');
        const middle = safeLower(p.middlename || '');
        const last = safeLower(p.surname || '');
        const nameVariants = [
          `${first} ${middle} ${last}`.replace(/\s+/g,' ').trim(),
          `${first} ${last}`.replace(/\s+/g,' ').trim(),
          `${last} ${first} ${middle}`.replace(/\s+/g,' ').trim(),
          `${last}, ${first}`.replace(/\s+/g,' ').trim(),
          `${first}${last}`.replace(/\s+/g,'').trim()
        ];
        const otherFields = `${safeLower(p.email || '')} ${safeLower(p.course || '')} ${safeLower(p.college || '')} ${safeLower(String(p.municipality || ''))} ${safeLower(String(p.birthmonth || ''))}`.trim();

        if(q){
          const matchesName = nameVariants.some(v => v.includes(q));
          const matchesOther = otherFields.includes(q);
          if(!matchesName && !matchesOther) return false;
        }

        if(batchV && safeLower(p.batch || '') !== batchV) return false;
        if(collegeV && safeLower(p.college || p.campus || '') !== collegeV) return false;
        if(courseV && safeLower(p.course || '') !== courseV) return false;
        if(municipalityV && safeLower(String(p.municipality || '')) !== municipalityV) return false;

        if(birthmonthV){
          if(/^\d+$/.test(birthmonthV)){
            const targetNum = parseInt(birthmonthV, 10);
            const personNum = p.birthmonthNum ? Number(p.birthmonthNum) : null;
            if(!personNum || personNum !== targetNum) return false;
          } else {
            if(safeLower(String(p.birthmonth || '')) !== safeLower(birthmonthV)) return false;
          }
        }

        if(statusV && safeLower(computeCompleteStatus(p)) !== statusV) return false;
        if(selectedLetter){
          const sname = safeLower(p.surname || '');
          if(!sname.startsWith(selectedLetter)) return false;
        }
        return true;
      });

      filteredData.sort(compareNames);
      renderCards(filteredData);
      updateAllSelectActiveStates();
      updateFilterHighlight();
      updateOptionButtons();
    }

    function updateFilterHighlight(){
      const anySearch = (searchInput && searchInput.value && searchInput.value.trim() !== '');
      const anySelect = (collegeSelect && collegeSelect.value && collegeSelect.value !== '') ||
                        (courseSelect && courseSelect.value && courseSelect.value !== '') ||
                        (municipalitySelect && municipalitySelect.value && municipalitySelect.value !== '') ||
                        (birthmonthSelect && birthmonthSelect.value && birthmonthSelect.value !== '') ||
                        (statusFilter && statusFilter.value && statusFilter.value !== '');
      const letterActive = !!selectedLetter;
      if(anySearch || anySelect || letterActive){
        sheetSelect && sheetSelect.classList.add('active');
      } else {
        sheetSelect && sheetSelect.classList.remove('active');
      }
    }

    /* ---------- UI wiring ---------- */
    if(searchInput) searchInput.addEventListener('input', ()=> applyFilters());
    if(batchSelect) batchSelect.addEventListener('change', ()=> { applyFilters(); updateSelectActive(batchSelect); });
    if(collegeSelect) collegeSelect.addEventListener('change', ()=> {
      const val = collegeSelect.value || '';
      if(!val){
        if(courseSelect){ courseSelect.style.display = 'none'; courseSelect.value = ''; }
        applyFilters();
        updateSelectActive(collegeSelect);
        return;
      }
      updateSelectActive(collegeSelect);
      populateCourseForCollege(val);
    });
    if(courseSelect) courseSelect.addEventListener('change', ()=> { updateSelectActive(courseSelect); applyFilters(); });
    if(municipalitySelect) municipalitySelect.addEventListener('change', ()=> { updateSelectActive(municipalitySelect); applyFilters(); });
    if(birthmonthSelect) birthmonthSelect.addEventListener('change', ()=> { updateSelectActive(birthmonthSelect); applyFilters(); });
    if(statusFilter) statusFilter.addEventListener('change', ()=> { updateSelectActive(statusFilter); applyFilters(); });

    if(btnMunicipality){
      btnMunicipality.addEventListener('click', ()=> openOptionModal('municipality'));
    }
    if(btnBirthmonth){
      btnBirthmonth.addEventListener('click', ()=> openOptionModal('birthmonth'));
    }

    if(btnReset){
      btnReset.addEventListener('click', ()=> {
        // reset search and filters
        if(searchInput) searchInput.value = '';
        if(batchSelect) batchSelect.value = '';
        if(collegeSelect) collegeSelect.value = '';
        if(courseSelect) { courseSelect.value = ''; courseSelect.style.display = 'none'; }
        if(municipalitySelect) municipalitySelect.value = '';
        if(birthmonthSelect) birthmonthSelect.value = '';
        if(statusFilter) statusFilter.value = '';
        // reset alphabet
        document.querySelectorAll('#alphabetContainer button').forEach(b=>b.classList.remove('active'));
        const allBtn = document.querySelector('#alphabetContainer button');
        if(allBtn) allBtn.classList.add('active');
        selectedLetter = '';
        updateAllSelectActiveStates();
        updateOptionButtons();
        applyFilters();
      });
    }

    /* ---------- Alphabet ---------- */
    function buildAlphabet(){
      if(!alphabetContainer) return;
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      alphabetContainer.innerHTML = '';
      const allBtn = document.createElement('button'); allBtn.type = 'button';
      allBtn.classList.add('active'); allBtn.innerText='All';
      allBtn.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(b=>b.classList.remove('active')); allBtn.classList.add('active'); selectedLetter = ''; applyFilters(); });
      alphabetContainer.appendChild(allBtn);
      letters.split('').forEach(l=>{
        const b = document.createElement('button'); b.type = 'button';
        b.innerText = l;
        b.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); selectedLetter = l.toLowerCase(); applyFilters(); });
        alphabetContainer.appendChild(b);
      });
    }

    /* ---------- Populate selects ---------- */
    function populateSelects(){
      function uniq(arr){ return [...new Set(arr.filter(x=>x !== undefined && x !== null && String(x).trim() !== ''))].sort(); }

      collegeCourseMap = {};
      allData.forEach(d=>{
        const col = d.college || d.campus || '';
        const crs = d.course || '';
        if(!col) return;
        const key = String(col).trim();
        if(!collegeCourseMap[key]) collegeCourseMap[key] = new Set();
        if(crs) collegeCourseMap[key].add(crs);
      });

      if(batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
      if(collegeSelect) collegeSelect.innerHTML = '<option value="">Select College</option>';
      if(courseSelect) courseSelect.innerHTML = '<option value="">Select Course</option>';
      if(municipalitySelect) municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
      if(birthmonthSelect) birthmonthSelect.innerHTML = '<option value="">Select BirthMonth</option>';

      uniq(allData.map(d => d.batch)).forEach(v=> batchSelect && (batchSelect.innerHTML += `<option>${v}</option>`));
      uniq(allData.map(d => d.college || d.campus)).forEach(v=> collegeSelect && (collegeSelect.innerHTML += `<option>${v}</option>`));
      uniq(allData.map(d => d.course)).forEach(v=> courseSelect && (courseSelect.innerHTML += `<option>${v}</option>`));

      const municipalities = uniq(allData.map(d => String(d.municipalityRaw || d.municipality || '').trim()));
      municipalities.forEach(v=> municipalitySelect && (municipalitySelect.innerHTML += `<option>${v}</option>`));

      const monthsPresent = new Set();
      allData.forEach(d => { if(d.birthmonthNum) monthsPresent.add(Number(d.birthmonthNum)); });
      const monthNums = Array.from(monthsPresent).sort((a,b)=>a-b);
      monthNums.forEach(num => {
        const name = monthNameFromNumber(num);
        birthmonthSelect && (birthmonthSelect.innerHTML += `<option value="${num}">${name}</option>`);
      });

      const rawBMStrings = uniq(allData.map(d => String(d.birthmonthRaw || '').trim()).filter(s=> s && !/^\d+$/.test(s)));
      rawBMStrings.forEach(s => {
        if(!monthNums.some(n => monthNameFromNumber(n).toLowerCase() === s.toLowerCase())){
          birthmonthSelect && (birthmonthSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }
      });

      if(courseSelect && courseSelect.value && courseSelect.value !== '') courseSelect.style.display = '';
      else if(courseSelect) courseSelect.style.display = 'none';

      if(municipalitySelect) municipalitySelect.style.display = 'none';
      if(birthmonthSelect) birthmonthSelect.style.display = 'none';

      updateFilterHighlight();
      updateOptionButtons();
    }

    /* ---------- Course selection ---------- */
    function populateCourseForCollege(collegeName){
      const set = collegeCourseMap[collegeName] || new Set();
      const arr = Array.from(set).sort();
      if(arr.length === 0){
        if(courseSelect){ courseSelect.style.display = 'none'; courseSelect.innerHTML = '<option value="">Select Course</option>'; courseSelect.value = ''; }
        applyFilters();
        return;
      }
      if(courseSelect) courseSelect.innerHTML = '<option value="">Select Course</option>';
      arr.forEach(c => {
        if(courseSelect){
          const opt = document.createElement('option');
          opt.value = c; opt.text = c; courseSelect.appendChild(opt);
        }
      });
      if(courseSelect) courseSelect.style.display = '';
      applyFilters();
    }

    /* ---------- Generic Option Modal ---------- */
    let currentOptionField = '';
    const optionClearBtn = document.getElementById('optionClearBtn');
    if(optionClearBtn){
      optionClearBtn.addEventListener('click', ()=>{ /* unused but kept for compatibility */ });
    }

    function openOptionModal(field){
      currentOptionField = field;
      if(!optionListEl) return;
      optionListEl.innerHTML = '';
      if(optionFallback) optionFallback.style.display = 'none';

      const clearTop = document.createElement('button');
      clearTop.type = 'button';
      clearTop.className = 'option-btn option-clear-top';
      clearTop.innerText = 'Clear selection';
      clearTop.addEventListener('click', ()=> {
        if(field === 'municipality'){ municipalitySelect && (municipalitySelect.value = ''); updateSelectActive(municipalitySelect); }
        else if(field === 'birthmonth'){ birthmonthSelect && (birthmonthSelect.value = ''); updateSelectActive(birthmonthSelect); }
        closeModalAll();
        applyFilters();
      });

      if(field === 'municipality'){
        if(optionModalTitle) optionModalTitle.innerText = 'Select Municipality';
        if(optionModalDesc) optionModalDesc.innerText = 'Choose a municipality to filter by:';
        const vals = [...new Set(allData.map(d => String(d.municipalityRaw || d.municipality || '').trim()).filter(Boolean))].sort();
        if(vals.length === 0){ if(optionFallback) optionFallback.style.display = ''; openModal('optionModal'); return; }
        optionListEl.appendChild(clearTop);
        vals.forEach(v=>{
          const b = document.createElement('button'); b.type = 'button'; b.className = 'option-btn'; b.innerText = v;
          b.addEventListener('click', ()=>{ municipalitySelect.value = v; updateSelectActive(municipalitySelect); closeModalAll(); applyFilters(); });
          optionListEl.appendChild(b);
        });
        openModal('optionModal');
        return;
      }

      if(field === 'birthmonth'){
        if(optionModalTitle) optionModalTitle.innerText = 'Select Birth Month';
        if(optionModalDesc) optionModalDesc.innerText = 'Choose a birth month to filter by:';
        const monthNums = [...new Set(allData.map(d => d.birthmonthNum).filter(Boolean))].sort((a,b)=>a-b);
        if(monthNums.length === 0){ if(optionFallback) optionFallback.style.display = ''; openModal('optionModal'); return; }
        optionListEl.appendChild(clearTop);
        monthNums.forEach(n=>{
          const name = monthNameFromNumber(n);
          const b = document.createElement('button'); b.type = 'button'; b.className = 'option-btn'; b.innerText = name;
          b.addEventListener('click', ()=>{ birthmonthSelect.value = String(n); updateSelectActive(birthmonthSelect); closeModalAll(); applyFilters(); });
          optionListEl.appendChild(b);
        });
        openModal('optionModal');
        return;
      }
    }

    /* ---------- Select active visuals ---------- */
    function updateSelectActive(selectEl){ if(!selectEl) return; if(selectEl.value && selectEl.value !== '') selectEl.classList.add('active'); else selectEl.classList.remove('active'); }
    function updateAllSelectActiveStates(){ [collegeSelect, courseSelect, batchSelect, municipalitySelect, birthmonthSelect, statusFilter].forEach(updateSelectActive); updateFilterHighlight(); }

    /* ---------- Option buttons reflect selections ---------- */
    function updateOptionButtons(){
      // municipality
      if(!btnMunicipality || !municipalitySelect) return;
      const val = municipalitySelect.value || '';
      if(val){
        btnMunicipality.innerText = val;
        btnMunicipality.classList.add('active');
      } else {
        btnMunicipality.innerText = 'Municipality';
        btnMunicipality.classList.remove('active');
      }
      // birthmonth
      if(!btnBirthmonth || !birthmonthSelect) return;
      const bval = birthmonthSelect.value || '';
      if(bval){
        // if bval is numeric, show month name
        if(/^\d+$/.test(String(bval))) btnBirthmonth.innerText = monthNameFromNumber(Number(bval));
        else btnBirthmonth.innerText = String(bval);
        btnBirthmonth.classList.add('active');
      } else {
        btnBirthmonth.innerText = 'Birth Month';
        btnBirthmonth.classList.remove('active');
      }
    }

    /* ---------- Reload / init ---------- */
    async function reloadAll(sheetName){
      showLoading();
      try {
        const raw = await fetchAllFromServer(sheetName);
        allData = raw || [];
        allData.sort(compareNames);
        populateSelects();
        buildAlphabet();
        applyFilters();
      } catch(err){
        console.error('Reload failed', err);
        if(cardsContainer) cardsContainer.innerHTML = `<p style="color:#a00">Unable to load alumni data. ${err.message || ''}</p>`;
      } finally {
        hideLoading();
      }
    }

    /* ---------- CSV Export ---------- */
    function escapeCSV(value){ if(value === null || value === undefined) return ''; const s = String(value); if(s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"'; return s; }
    function exportToCSV(data){
      if(!Array.isArray(data)) data = [];
      const headers = ['Surname','First Name','Middle Name','Birthdate','Gender','Address','CpNumber','Email','Position','Job'];
      const lines = [headers.join(',')];
      data.forEach(d=>{
        const row = [
          escapeCSV(d.surname || ''),
          escapeCSV(d.firstname || ''),
          escapeCSV(d.middlename || ''),
          escapeCSV(d.birthday || ''),
          escapeCSV(d.gender || ''),
          escapeCSV(d.address || ''),
          escapeCSV(d.cpnumber || ''),
          escapeCSV(d.email || ''),
          escapeCSV(d.designation || d.position || ''),
          escapeCSV(d.job || '')
        ];
        lines.push(row.join(','));
      });
      const csv = lines.join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `alumni_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    if(exportBtnTop) exportBtnTop.addEventListener('click', ()=>{ const dataToExport = Array.isArray(filteredData) && filteredData.length >= 0 ? filteredData : allData; exportToCSV(dataToExport); });

    /* ---------- Sheet select handling ---------- */
    if(sheetSelect) sheetSelect.addEventListener('change', (e)=>{
      const val = sheetSelect.value || '2025';
      if(val === 'Alumni Management Directory') return;
      currentSheet = val;
      reloadAll(currentSheet);
    });

    /* ---------- Init ---------- */
    (function init(){
      currentSheet = sheetSelect && sheetSelect.value && sheetSelect.value !== 'Alumni Management Directory' ? sheetSelect.value : '2025';
      buildAlphabet();
      // initial load (wrap in try/catch to avoid unhandled rejection in dev)
      reloadAll(currentSheet).catch(err => console.warn('Initial load error', err));
    })();
    </script>
</body>
</html>
