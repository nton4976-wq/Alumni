<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alumni Nexus | Management Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
    :root{
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --secondary: #0ea5e9;
  --bg-body: #f3f4f6;
  --bg-card: rgba(255,255,255,0.95);
  --text-main: #111827;
  --text-muted: #6b7280;
  --glass-border: rgba(255,255,255,0.5);
  --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.12), 0 10px 10px -5px rgba(0,0,0,0.04);
  --status-complete-bg: rgba(16,185,129,0.12);
  --status-incomplete-bg: rgba(239,68,68,0.09);

  /* Layout tuning */
  --app-max-width: 1400px;
  --gutter: 1rem;

  /* Card sizing */
  --card-min-height: 300px;
  --card-min-height-mobile: 260px;
}

/* ---------- Reset & base ---------- */
*{ box-sizing: border-box; margin:0; padding:0; font-family: 'Plus Jakarta Sans', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body{ height:100%; }
body{
  background-color: var(--bg-body);
  background-image:
    radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
    radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
    radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
  background-attachment: fixed;
  color: var(--text-main);
  min-height: 100vh;
  line-height: 1.5;
  padding: 2rem 0;
  -webkit-tap-highlight-color: transparent;
}

/* ---------- App container & header ---------- */
.app-container{ max-width: var(--app-max-width); margin: 0 auto; padding: 2rem; }
header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; gap:1rem; flex-wrap:wrap; }
.brand{ display:flex; align-items:center; gap:1rem; }
.brand-icon{
  width:48px; height:48px; border-radius:12px;
  background: linear-gradient(135deg,rgba(106,90,249,0.8),rgba(143,123,255,0.8));
  display:flex; align-items:center; justify-content:center; color:white; font-size:1.25rem; box-shadow:var(--shadow-md);
  flex-shrink:0;
}
.brand h1{ font-size:1.25rem; font-weight:800; color:white; line-height:1; margin:0; }
.brand span{ display:block; font-size:0.85rem; color:rgba(255,255,255,0.85); font-weight:600; }

/* ---------- Controls bar ---------- */
.controls-bar{
  background: var(--bg-card);
  backdrop-filter: blur(8px);
  border-radius: 1rem;
  padding: 1rem;
  border:1px solid var(--glass-border);
  box-shadow: var(--shadow-lg);
  display:flex; justify-content:space-between; gap:1rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem;
}

/* Filter group and inputs */
.filter-group{ display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
.search-box{ position:relative; }
.search-box input{
  padding: 0.6rem 1rem 0.6rem 2.6rem;
  border: 1px solid #e5e7eb;
  border-radius:0.75rem;
  width:280px;
  font-size:0.92rem;
  background:#f9fafb;
  color:var(--text-main);
  outline:none;
}
.search-box input::placeholder{ color:var(--text-muted); font-weight:600; }
.search-box i{ position:absolute; left:0.9rem; top:50%; transform:translateY(-50%); color:var(--text-muted); pointer-events:none; }

/* selects, buttons */
select, button{
  padding: 0.55rem 0.9rem; border-radius:0.75rem; border:1px solid #e5e7eb; background:white; font-size:0.9rem; font-weight:600; cursor:pointer;
}
select:focus, button:focus{ outline:2px solid rgba(79,70,229,0.12); outline-offset:2px; }

/* primary button */
.btn-primary{ background:var(--primary); color:white; border:none; display:inline-flex; gap:0.5rem; align-items:center; box-shadow:var(--shadow-sm); }
.btn-primary:hover{ background:var(--primary-hover); }

/* icon circle button */
.btn-icon{ width:40px; height:40px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center; background:white; border:1px solid #e5e7eb; }

/* option-like buttons that reflect selection */
.btn-option{
  border-radius:0.75rem;
  padding:0.55rem 0.9rem;
  display:inline-flex;
  gap:0.5rem;
  align-items:center;
  min-width:130px;
  background:white;
  border:1px solid #e5e7eb;
  font-weight:700;
  transition: all .12s ease;
}
.btn-option.active{
  background: linear-gradient(90deg, rgba(79,70,229,0.12), rgba(14,165,233,0.08));
  border-color: rgba(79,70,229,0.35);
  color: var(--text-main);
  box-shadow: var(--shadow-sm);
}

/* small controls */
.tabs{ display:flex; gap:0.5rem; align-items:center; }
.tabs button{ padding:0.4rem 0.7rem; border-radius:8px; background:transparent; border:1px solid transparent; font-weight:700; cursor:pointer; }
.tabs button.active{ background:var(--text-main); color:white; border-color:var(--text-main); transform:translateY(-1px); }

/* ---------- Stats grid ---------- */
.stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1.25rem; }
.stat-card{ background:var(--bg-card); padding:1rem; border-radius:12px; display:flex; gap:1rem; align-items:center; border:1px solid var(--glass-border); box-shadow:var(--shadow-md); }
.stat-icon{ width:48px;height:48px;border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; flex-shrink:0; }
.stat-icon.blue{background:#dbeafe;color:#2563eb;} .stat-icon.green{background:#d1fae5;color:#059669;} .stat-icon.purple{background:#e0e7ff;color:#4f46e5;} .stat-icon.orange{background:#ffedd5;color:#ea580c;}
.stat-info h3{font-size:1.25rem;font-weight:800;margin:0;} .stat-info p{font-size:0.85rem;color:var(--text-muted);font-weight:600;margin:0;}

/* ---------- Alphabet filter ---------- */
.alphabet-filter{ display:flex; gap:0.25rem; margin-bottom:1rem; overflow-x:auto; padding-bottom:0.5rem; -webkit-overflow-scrolling:touch; }
.alphabet-filter::-webkit-scrollbar{ height:6px; }
.alphabet-filter button{ min-width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; font-weight:700; font-size:0.85rem; border:1px solid transparent; background:white; cursor:pointer; white-space:nowrap; }
.alphabet-filter button.active{ background:var(--text-main); color:white; border-color:var(--text-main); }

/* ---------- Cards grid ---------- */
.cards-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; }

/* card container - flexible (no fixed absolute height) */
.card{
  background: transparent;
  border-radius:12px;
  padding:0;
  overflow:visible;
  position:relative;
  min-height: var(--card-min-height);
  perspective: 1200px;
  display:block;
}
.card-inner{
  width:100%;
  height:100%;
  transition: transform 0.7s cubic-bezier(.2,.9,.2,1);
  transform-style: preserve-3d;
  position:relative;
  min-height: inherit;
  display:block;
}
.card.flipped .card-inner{ transform: rotateY(180deg); }

/* faces */
.card-face{
  position:absolute;
  inset:0;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow-md);
  background: var(--bg-card);
  min-height: inherit;
}

/* back face rotated */
.card-back{ transform: rotateY(180deg); padding:1rem; background: linear-gradient(180deg,#ffffff,#f7f7fb); }

/* front header */
.card .card-header{ height:40px; background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); position:relative; display:flex; align-items:center; justify-content:center; }

/* avatar overlaps header and body (right side) */
.card-front .avatar{
  position:absolute;
  right:18px;
  top:62px; /* overlaps header */
  transform:translateY(-50%);
  width:72px;
  height:72px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:1.6rem;
  color: var(--text-main);
  background: #fbf9ec; /* subtle warm background like the example */
  box-shadow: 0 10px 20px rgba(2,6,23,0.12);
  border:6px solid rgba(255,255,255,0.95);
  z-index: 5;
}

/* content area for front card */
.card-front .card-body{
  padding:18px 18px 14px 18px;
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:flex-start; /* left-aligned content */
}
.card-face.card-front h3{ font-size:1.05rem; margin:0; font-weight:800; color:var(--text-main); text-align:left; width:100%; }
.card-front .role{ font-size:0.92rem; color:var(--text-muted); font-weight:700; margin-top:0.15rem; text-align:left; width:100%; }

/* info rows (icons) kept minimal on front */
.card-front .info{ display:flex; flex-direction:column; gap:6px; margin-top:8px; color:var(--text-muted); font-weight:600; width:100%; }
.card-front .info p{ display:flex; gap:0.6rem; align-items:center; margin:0; font-size:0.88rem; }
.card-front .info i{ opacity:0.85; }

/* footer row with status + view button */
.card-front .card-footer{ display:flex; align-items:center; justify-content:space-between; padding:0 14px 14px 14px; width:100%; gap:8px; box-sizing:border-box; }
.card-front .card-footer .view{ border-radius:8px; padding:0.45rem 0.7rem; font-weight:700; }

/* other existing classes (kept) */
.card h3{ text-align:center; margin:0.6rem 1rem 0; font-size:1.05rem; font-weight:800; color:var(--text-main); padding:0 1rem; line-height:1.2; }
.card .role{ text-align:center; color:var(--text-muted); font-weight:700; margin-top:0.25rem; font-size:0.9rem; }

/* Rest unchanged: info area scrollable if content is larger */
.card .info{ padding:0.75rem 1rem; font-size:0.9rem; color:var(--text-muted); display:flex; flex-direction:column; gap:0.35rem; margin-top:0.5rem; flex:1; overflow:auto; -webkit-overflow-scrolling:touch; }
.card .info p{ display:flex; gap:0.6rem; align-items:center; font-weight:600; color:var(--text-muted); margin:0; }
.card .info p small{ color:var(--text-muted); font-weight:500; }

/* action row at bottom (backface uses .card-back with its own layout) */
.card .actions{ display:flex; gap:0.5rem; margin:0.75rem 1rem 1rem 1rem; }
.card .actions button{ flex:1; padding:0.5rem; border-radius:8px; font-weight:700; font-size:0.9rem; }

/* status indicator */
.status-indicator{ display:inline-flex; gap:0.5rem; align-items:center; padding:0.35rem 0.6rem; border-radius:999px; font-weight:800; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.04em; }
.status-indicator.complete{ background: var(--status-complete-bg); color:#059669; }
.status-indicator.incomplete{ background: var(--status-incomplete-bg); color:#ef4444; }

/* card back grid */
.back-grid{ display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; margin-top:0.5rem; }
.back-item{ background:rgba(0,0,0,0.02); padding:0.6rem; border-radius:8px; font-weight:700; color:var(--text-main); font-size:0.9rem; }

/* empty state */
.empty-state{ grid-column:1/-1; text-align:center; padding:3rem; color:white; background: linear-gradient(180deg, rgba(0,0,0,0.15), transparent); border-radius:12px; }

/* ---------- Modal overlay & content ---------- */
.modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:1000; padding:1rem; }
.modal-overlay.active{ display:flex; }
.modal-content{ background:white; padding:1.25rem; border-radius:12px; width:90%; max-width:520px; box-shadow:var(--shadow-xl); max-height:85vh; overflow:auto; -webkit-overflow-scrolling:touch; }
.modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
.option-list{ display:flex; flex-direction:column; gap:0.5rem; max-height:320px; overflow:auto; -webkit-overflow-scrolling:touch; padding-right:0.25rem; }
.option-btn{ text-align:left; padding:0.6rem 0.9rem; border-radius:8px; border:1px solid #e5e7eb; background:white; cursor:pointer; font-weight:700; }

/* fallback message */
#optionFallback{ display:none; color:#a00; padding:0.6rem; }

/* ---------- Loading overlay ---------- */
.loader{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000; background:rgba(255,255,255,0.9); flex-direction:column; }
.loader .spinner{ width:50px; height:50px; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin{ 0%{ transform:rotate(0); } 100%{ transform:rotate(360deg); } }

/* ---------- Small helpers ---------- */
.hidden{ display:none !important; }
.btn-ghost{ background:transparent; border:1px solid #e5e7eb; color:var(--text-main); }

/* ---------- Accessibility & touch sizes ---------- */
.btn-icon, .option-btn, .option-clear-top, .btn-option{ min-height:44px; min-width:44px; }
button, select, input{ -webkit-user-select:none; -ms-user-select:none; user-select:none; }

/* ---------- Responsive rules (breakpoints) ---------- */

/* Very small phones */
@media (max-width: 480px){
  .app-container{ padding:1rem; }
  .brand h1{ font-size:1rem; }
  .brand-icon{ width:40px; height:40px; }
  .search-box input{ width:140px; font-size:0.9rem; }
  .alphabet-filter button{ min-width:30px; height:34px; font-size:0.78rem; padding:0.2rem; }
  .cards-grid{ grid-template-columns: 1fr; gap:0.8rem; }
  .card{ min-height: var(--card-min-height-mobile); }
  .card .card-header{ height:60px; }
  .modal-content{ width:100%; max-width:420px; margin:0 12px; }
  .status-indicator{ font-size:0.65rem; padding:0.28rem 0.45rem; }
  .controls-bar{ padding:0.75rem; gap:0.5rem; }
  .controls-bar{ flex-direction:column; align-items:stretch; }
  .controls-bar > div[style] { width:100%; display:flex; justify-content:space-between; gap:.5rem; }
  .card-front .avatar{ right:12px; width:64px; height:64px; top:56px; font-size:1.25rem; border-width:5px; }
}

/* Small tablets & phablets */
@media (min-width: 481px) and (max-width: 767px){
  .search-box input{ width:160px; }
  .cards-grid{ grid-template-columns: repeat(1, 1fr); }
  .controls-bar{ flex-direction:column; align-items:stretch; }
}

/* Tablet */
@media (min-width: 768px) and (max-width: 991px){
  .cards-grid{ grid-template-columns: repeat(2, 1fr); }
  .search-box input{ width:200px; }
  .brand h1{ font-size:1.05rem; }
}

/* Laptop / small desktop */
@media (min-width: 992px) and (max-width: 1279px){
  .cards-grid{ grid-template-columns: repeat(2, 1fr); }
  .search-box input{ width:240px; }
}

/* Desktop & wide */
@media (min-width: 1280px){
  .cards-grid{ grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
  .app-container{ max-width:var(--app-max-width); padding:2rem; }
  .search-box input{ width:280px; }
}

/* make sure card-inner transitions are smooth for reduced motion users */
@media (prefers-reduced-motion: reduce){
  .card-inner{ transition:none !important; }
}

/* ---------- Minor tweaks for nicer behavior ---------- */
/* keep infos scrollable but remove inner scrollbars until needed */
.card .info::-webkit-scrollbar{ width:8px; height:8px; }
.card .info::-webkit-scrollbar-thumb{ border-radius:8px; background: rgba(0,0,0,0.06); }

/* ensure modal close area large enough on small screens */
.modal-content .modal-header button{ font-size:1.1rem; line-height:1; padding:0.25rem 0.6rem; border-radius:8px; }

/* make the "All" alphabet button slightly standout on load */
.alphabet-filter button:first-child{ min-width:44px; font-weight:800; }

/* Improve visual for active selects */
select.active, .btn-option.active{ box-shadow: 0 4px 10px rgba(79,70,229,0.08); }

/* ensure exported CSV link elements won't show */
a[download]{ text-decoration:none; color:inherit; }

/* End of stylesheet */

/* === Card height compact override (paste at end of stylesheet) === */

/* Lower the min-height for most screens and mobile */
:root {
  --card-min-height: 240px;         /* default compact height (was 300px) */
  --card-min-height-mobile: 220px;  /* compact mobile height */
}

/* ensure card uses the new min-height */
.card {
  min-height: var(--card-min-height) !important;
}

/* Reduce header height so it doesn't push the card */
.card .card-header {
  height: 56px !important; /* was 90/72 depending on rules */
}

/* Make avatar smaller and reposition to fit visually */
.card-front .avatar {
  width: 56px !important;
  height: 56px !important;
  top: 50px !important;
  right: 14px !important;
  transform: translateY(-50%) !important;
  font-size: 1.1rem !important;
  border-width: 4px !important;
}

/* Tighter padding in front body and footer */
.card-front .card-body {
  padding: 12px 12px 10px 12px !important;
}
.card-front .card-footer {
  padding: 0 12px 10px 12px !important;
}

/* Slightly smaller headline + role to save vertical space */
.card-face.card-front h3,
.card h3 {
  font-size: 1.00rem !important; /* was ~1.05rem */
  margin-top: 6px !important;
}
.card-front .role,
.card .role {
  font-size: 0.86rem !important; /* was ~0.9rem */
  margin-top: 0.15rem !important;
}

/* Compact info rows */
.card-front .info {
  gap: 4px !important;
  margin-top: 6px !important;
  padding: 0 !important; /* use card-body padding instead */
}
.card .info p {
  font-size: 0.86rem !important;
}

/* Reduce spacing on back items */
.back-grid { gap: 0.4rem !important; }
.back-item { padding: 0.5rem !important; font-size: 0.86rem !important; }

/* Ensure mobile uses the mobile min-height */
@media (max-width: 480px) {
  :root { --card-min-height: var(--card-min-height-mobile); }
  .card .card-header { height: 52px !important; }
  .card-front .avatar { width: 52px !important; height: 52px !important; top: 48px !important; border-width:4px !important; }
  .card h3 { font-size: 0.98rem !important; }
  .card .role { font-size: 0.82rem !important; }
}

/* Keep info area scrollable so content doesn't expand the card */
.card .info { overflow:auto; -webkit-overflow-scrolling: touch; }

/* Optional: slightly tighter shadow to reduce perceived bulk */
.card-face { box-shadow: 0 6px 12px rgba(2,6,23,0.06) !important; }


/* Reduce side margins on very wide screens (e.g. 1920x1080) */
@media (min-width: 1920px) {
  /* increase max width so content fills more of the screen */
  :root { --app-max-width: 1800px; }

  /* tighten horizontal padding on the container */
  .app-container{
    max-width: var(--app-max-width);
    padding-left: 1.25rem;   /* was 2rem */
    padding-right: 1.25rem;  /* was 2rem */
  }

  /* optional: slightly reduce body side padding if you want even less outer gutter */
  body {
    padding-left: 0.5rem;    /* was 2rem (vertical remains controlled by padding shorthand) */
    padding-right: 0.5rem;
  }
}
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader" class="loader" style="display:none;">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--text-main);">Loading Alumni Data...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header>
            <div class="brand">
                <div class="brand-icon"><i class="fa-solid fa-graduation-cap"></i></div>
                <div>
                    <h1>RSU Alumni</h1>
                    <span>Management Directory System</span>
                </div>
            </div>

            <div style="display:flex; gap:0.75rem; align-items:center;">
                <!-- sheetSelect already exists and is used as currentSheet selector -->
                <select id="sheetSelect" class="active" style="font-weight:700;">
                    <option value="2025">Batch 2025</option>
                    <option value="2024">Batch 2024</option>
                </select>

                <!-- export button (id matches JS) -->
                <button id="exportBtnTop" class="btn-primary">
                    <i class="fa-solid fa-download"></i> Export CSV
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fa-solid fa-users"></i></div>
                <div class="stat-info"><h3 id="stat-total">0</h3><p>Total Graduates</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fa-solid fa-user-check"></i></div>
                <div class="stat-info"><h3 id="stat-complete">0</h3><p>Profiles Complete</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fa-solid fa-mars"></i></div>
                <div class="stat-info"><h3 id="stat-male">0</h3><p>Male Alumni</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fa-solid fa-venus"></i></div>
                <div class="stat-info"><h3 id="stat-female">0</h3><p>Female Alumni</p></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <div class="filter-group">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search name, email, course...">
                </div>

                <!-- Batch select hidden as requested -->
                <select id="batchSelect" style="display:none;">
                    <option value="">Select Batch</option>
                </select>

                <select id="collegeSelect">
                    <option value="">All Colleges</option>
                </select>

                <select id="courseSelect" style="display:none;">
                    <option value="">All Courses</option>
                </select>
            </div>

            <div style="display:flex; align-items:center; gap:0.5rem;">
                <!-- Status dropdown: All / Complete / Incomplete -->
                <select id="statusFilter" style="font-weight:700;">
                    <option value="">All Status</option>
                    <option value="complete">Complete</option>
                    <option value="incomplete">Incomplete</option>
                </select>

                <!-- municipality & birthmonth as buttons that show selected -->
                <button id="btn-municipality" class="btn-option" title="Municipality">Municipality</button>
                <button id="btn-birthmonth" class="btn-option" title="Birth Month">Birth Month</button>

                <!-- undo/reset -->
                <button class="btn-icon" id="btn-reset" title="Reset Filters"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <!-- Alphabet -->
        <div class="alphabet-filter" id="alphabetContainer"></div>

        <!-- Grid -->
        <div class="cards-grid" id="cardsContainer"></div>
    </div>

    <!-- Generic Option Modal -->
    <div class="modal-overlay" id="optionModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select Option</h3>
                <button class="modal-close" onclick="closeModalAll()">&times;</button>
            </div>
            <p id="optionModalDesc" style="color:var(--text-muted); margin-bottom:0.5rem;">Choose an option:</p>
            <div id="optionFallback" style="display:none; color:#a00; padding:0.6rem;">No options available</div>
            <div class="option-list" id="optionList"></div>
        </div>
    </div>

    <!-- Hidden selects referenced by JS (municipality, birthmonth) -->
    <select id="municipalitySelect" style="display:none;"><option value="">Select Municipality</option></select>
    <select id="birthmonthSelect" style="display:none;"><option value="">Select Birthmonth</option></select>

    <!-- Small placeholders for potentially referenced elements in script -->
    <div id="courseModal" style="display:none;"></div>
    <div id="courseList" style="display:none;"></div>
    <div id="courseFallback" style="display:none;"></div>
    <button id="optionClearBtn" style="display:none;"></button>

    <script>
    /* ====== CONFIG ====== */
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwldYgvc5aQy9iFnI0qvminmd5r3mh1gwKv6WO98O_a4ENfNG8o_tzmfBfu_eth6g/exec';

    /* ---------- Helpers ---------- */
    function normalizeKey(s){ return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,''); }
    function safeLower(v){ return String(v || '').toLowerCase(); }
    function uid(){ return 'u_' + Date.now() + '_' + Math.floor(Math.random()*10000); }
    function isBlankOrNA(value){ if(value === null || value === undefined) return true; const s = String(value).trim(); return s === '' || /^(-|n\/a|na)$/i.test(s); }
    const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    function monthNumberFromAny(v){
      if(v === null || v === undefined) return null;
      if(typeof v === 'number' && !isNaN(v) && v >= 1 && v <= 12) return v;
      const s = String(v).trim();
      if(s === '') return null;
      if(/^\d{1,2}$/.test(s)){
        const n = parseInt(s,10);
        if(n >=1 && n <= 12) return n;
      }
      const parsed = Date.parse(s);
      if(!isNaN(parsed)){
        const d = new Date(parsed);
        return d.getMonth() + 1;
      }
      const monthRegex = /(jan(uary)?|feb(ruary)?|mar(ch)?|apr(il)?|may|jun(e)?|jul(y)?|aug(ust)?|sep(t)?(ember)?|oct(ober)?|nov(ember)?|dec(ember)?)/i;
      const m = s.match(monthRegex);
      if(m){
        const found = m[0].toLowerCase();
        for(let i=0;i<MONTH_NAMES.length;i++){
          if(MONTH_NAMES[i].toLowerCase().startsWith(found)) return i+1;
        }
      }
      return null;
    }
    function monthNameFromNumber(num){ const n = parseInt(num,10); if(isNaN(n) || n<1 || n>12) return ''; return MONTH_NAMES[n-1]; }
    function formatBirthday(v){
      if(!v) return '';
      let d = null;
      if(typeof v === 'number') d = new Date(v);
      if(typeof v === 'string'){
        const s = v.trim();
        const iso = Date.parse(s);
        if(!isNaN(iso)) d = new Date(iso);
        else {
          const parts1 = s.split(/[\/\-\.\s]+/).map(p=>p.trim());
          if(parts1.length === 3){
            if(parts1[0].length === 4){
              const y = parseInt(parts1[0],10), m = parseInt(parts1[1],10)-1, day = parseInt(parts1[2],10);
              d = new Date(y,m,day);
            } else {
              const a = new Date(parseInt(parts1[2],10), parseInt(parts1[0],10)-1, parseInt(parts1[1],10));
              if(!isNaN(a)) d = a;
              else {
                const b = new Date(parseInt(parts1[2],10), parseInt(parts1[1],10)-1, parseInt(parts1[0],10));
                if(!isNaN(b)) d = b;
              }
            }
          }
        }
      }
      if(!d || isNaN(d)) return String(v);
      const m = MONTH_NAMES[d.getMonth()];
      const day = d.getDate();
      const year = d.getFullYear();
      return `${m} ${day}, ${year}`;
    }
    function parseDateFromAny(v){
      if(!v) return null;
      if(v instanceof Date && !isNaN(v)) return v;
      if(typeof v === 'number'){ const d=new Date(v); if(!isNaN(d)) return d; return null; }
      const s = String(v).trim();
      if(s==='') return null;
      const iso = Date.parse(s);
      if(!isNaN(iso)) return new Date(iso);
      const parts = s.split(/[\/\-\.\s]+/).map(p=>p.trim());
      if(parts.length===3){
        if(parts[0].length===4){
          const y=parseInt(parts[0],10), m=parseInt(parts[1],10)-1, day=parseInt(parts[2],10);
          const d = new Date(y,m,day); if(!isNaN(d)) return d;
        }
        let d1 = new Date(parseInt(parts[2],10), parseInt(parts[0],10)-1, parseInt(parts[1],10)); if(!isNaN(d1)) return d1;
        let d2 = new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10)); if(!isNaN(d2)) return d2;
      }
      return null;
    }
    function computeAgeFromBirthday(bday){
      if(!bday) return null;
      const d = parseDateFromAny(bday);
      if(!d) return null;
      const now = new Date();
      let age = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
      return age >= 0 ? age : null;
    }
    function computeCompleteStatus(person){
      const hasMiddle = !isBlankOrNA(person.middlename);
      const hasEmail = !isBlankOrNA(person.email);
      const hasPhone = !isBlankOrNA(person.cpnumber);
      if(hasMiddle && hasEmail && hasPhone) return 'complete';
      return 'incomplete';
    }

    /* ---------- DOM refs (aligned with markup) ---------- */
    const cardsContainer = document.getElementById('cardsContainer');
    const searchInput = document.getElementById('searchInput');
    const alphabetContainer = document.getElementById('alphabetContainer');
    const batchSelect = document.getElementById('batchSelect');
    const collegeSelect = document.getElementById('collegeSelect');
    const courseSelect = document.getElementById('courseSelect');
    const municipalitySelect = document.getElementById('municipalitySelect');
    const birthmonthSelect = document.getElementById('birthmonthSelect');
    const statusFilter = document.getElementById('statusFilter');

    const exportBtnTop = document.getElementById('exportBtnTop');
    const sheetSelect = document.getElementById('sheetSelect');
    const loadingOverlay = document.getElementById('loader');

    const optionModal = document.getElementById('optionModal');
    const optionListEl = document.getElementById('optionList');
    const optionModalTitle = document.getElementById('modalTitle');
    const optionModalDesc = document.getElementById('optionModalDesc');
    const optionFallback = document.getElementById('optionFallback');

    const btnMunicipality = document.getElementById('btn-municipality');
    const btnBirthmonth = document.getElementById('btn-birthmonth');
    const btnReset = document.getElementById('btn-reset');

    let allData = [];
    let filteredData = [];
    let selectedLetter = '';
    let collegeCourseMap = {};
    let currentSheet = '2025';

    /* ---------- Loading overlay helpers ---------- */
    function showLoading(){
      if(sheetSelect) sheetSelect.disabled = true;
      if(exportBtnTop) exportBtnTop.disabled = true;
      if(collegeSelect){ collegeSelect.innerHTML = '<option>Loading...</option>'; collegeSelect.disabled = true; }
      if(batchSelect){ batchSelect.innerHTML = '<option>Loading...</option>'; batchSelect.disabled = true; }
      if(courseSelect){ courseSelect.innerHTML = '<option>Loading...</option>'; courseSelect.disabled = true; }
      if(municipalitySelect){ municipalitySelect.innerHTML = '<option>Loading...</option>'; municipalitySelect.disabled = true; }
      if(birthmonthSelect){ birthmonthSelect.innerHTML = '<option>Loading...</option>'; birthmonthSelect.disabled = true; }
      if(loadingOverlay) loadingOverlay.style.display = 'flex';
    }
    function hideLoading(){
      if(sheetSelect) sheetSelect.disabled = false;
      if(exportBtnTop) exportBtnTop.disabled = false;
      if(collegeSelect){ collegeSelect.disabled = false; }
      if(batchSelect){ batchSelect.disabled = false; }
      if(courseSelect){ courseSelect.disabled = false; }
      if(municipalitySelect){ municipalitySelect.disabled = false; }
      if(birthmonthSelect){ birthmonthSelect.disabled = false; }
      if(loadingOverlay) loadingOverlay.style.display = 'none';
    }

    /* ---------- Server interaction (unchanged) ---------- */
    async function fetchAllFromServer(sheetName){
      const sheetParam = sheetName ? `?sheet=${encodeURIComponent(sheetName)}` : '';
      const url = WEBAPP_URL + sheetParam;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Failed to fetch from server: ' + res.statusText);
      const data = await res.json();
      if(!Array.isArray(data)) {
        if(data && data.error) throw new Error(data.error);
        throw new Error('Unexpected response from server');
      }
      return data.map((r, idx) => {
        const rownum = r._row || r.row || r.rowNumber || r.rowNum;
        if(!r._uid) r._uid = r.id ? String(r.id) : uid();
        r._row = rownum;
        r.firstname = r.firstname || r.firstName || r.first || '';
        r.middlename = r.middlename || r.middleName || r.middle || '';
        r.surname = r.surname || r.lastName || r.last || '';
        r.cpnumber = r.cpnumber || r.phone || r.mobile || '';
        r.email = r.email || r.Email || '';
        r.college = r.college || r.campus || '';
        r.course = r.course || '';
        r.batch = r.batch || '';
        r.designation = r.designation || r.position || '';
        r.job = r.job || r.designation || '';
        r.address = r.address || r.Address || '';
        r.gender = r.gender || '';
        const rawMunicipality = r.municipality || r.munic || r.city || r.town || r.muni || '';
        r.municipalityRaw = rawMunicipality;
        r.municipality = rawMunicipality;
        r.birthday = r.birthday || r.birthdate || r.dob || '';
        let rawBM = (r.birthmonth !== undefined && r.birthmonth !== null) ? r.birthmonth : '';
        r.birthmonthRaw = rawBM;
        const bmNumFromField = monthNumberFromAny(rawBM);
        if(bmNumFromField){
          r.birthmonthNum = bmNumFromField;
          r.birthmonth = monthNameFromNumber(bmNumFromField);
        } else {
          const bmNumFromBirthday = monthNumberFromAny(r.birthday);
          if(bmNumFromBirthday){
            r.birthmonthNum = bmNumFromBirthday;
            r.birthmonth = monthNameFromNumber(bmNumFromBirthday);
          } else {
            r.birthmonthNum = null;
            r.birthmonth = rawBM ? String(rawBM).trim() : '';
          }
        }
        r.complete = computeCompleteStatus(r);
        const hasRealPerson = !isBlankOrNA(r.firstname) || !isBlankOrNA(r.surname) || !isBlankOrNA(r.email);
        if(!hasRealPerson) return null;
        return r;
      }).filter(Boolean);
    }

    async function updateOnServer(row, data){
      const sheetParam = currentSheet ? `?sheet=${encodeURIComponent(currentSheet)}` : '';
      const url = WEBAPP_URL + sheetParam;
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action:'update', row: row, data })
      });
      return res.json();
    }

    /* ---------- Sorting / rendering helpers ---------- */
    function compareNames(a, b){
      const as = safeLower(a.surname || '');
      const bs = safeLower(b.surname || '');
      const af = safeLower(a.firstname || '');
      const bf = safeLower(b.firstname || '');
      if(as === '' && bs !== '') return 1;
      if(as !== '' && bs === '') return -1;
      if(as < bs) return -1;
      if(as > bs) return 1;
      if(af < bf) return -1;
      if(af > bf) return 1;
      return 0;
    }

    function initialsFor(p){
      const surname = !isBlankOrNA(p.surname) ? p.surname : '';
      const firstname = !isBlankOrNA(p.firstname) ? p.firstname : '';
      const s = surname ? surname.charAt(0).toUpperCase() : '';
      let f = '';
      if(firstname){
        const firstWord = firstname.split(/\s+/)[0] || '';
        f = firstWord ? firstWord.charAt(0).toUpperCase() : '';
      }
      if(s && f) return s + f;
      if(s) return s;
      if(f) return f;
      return (p.firstname ? p.firstname.charAt(0).toUpperCase() : 'A');
    }

    function renderCard(p){
      const hasAny = !(
        isBlankOrNA(p.firstname) &&
        isBlankOrNA(p.middlename) &&
        isBlankOrNA(p.surname) &&
        isBlankOrNA(p.email) &&
        isBlankOrNA(p.cpnumber) &&
        isBlankOrNA(p.address) &&
        isBlankOrNA(p.gender) &&
        isBlankOrNA(p.course) &&
        isBlankOrNA(p.college) &&
        isBlankOrNA(p.batch)
      );
      if(!hasAny) return '';

      const surname = isBlankOrNA(p.surname) ? '' : p.surname;
      const firstname = isBlankOrNA(p.firstname) ? '' : p.firstname;
      const middlename = isBlankOrNA(p.middlename) ? '' : p.middlename;
      const displayName = surname ? `${surname}, ${firstname}${middlename ? ' ' + middlename : ''}` : `${firstname} ${middlename}`.trim() || 'Unknown';
      const completeClass = computeCompleteStatus(p) === 'complete' ? 'complete' : 'incomplete';
      const gender = p.gender || 'Not specified';
      const address = p.address || (p.municipality || 'No address provided');
      const cp = p.cpnumber || 'No contact number';
      const email = p.email || 'No email';
      const age = computeAgeFromBirthday(p.birthday);
      const initials = initialsFor(p);

      // Build front/back with flip-ready markup (front now includes overlapping avatar + left-aligned name)
      return `
        <div class="card" data-uid="${p._uid}" data-row="${p._row || ''}"
             data-surname="${safeLower(surname)}" data-gender="${safeLower(gender)}" data-batch="${safeLower(p.batch||'') }"
             data-college="${safeLower(p.college||'')}" data-course="${safeLower(p.course||'')}" data-complete="${safeLower(computeCompleteStatus(p))}"
             data-email="${String(email).replace(/"/g,'&quot;')}" data-phone="${String(cp).replace(/"/g,'&quot;')}" data-college-display="${p.college || ''}" data-course-display="${p.course || ''}"
             data-position="${p.designation || ''}" data-address="${address}" data-job="${p.job || ''}" data-birthday="${(p.birthday || '')}">
          <div class="card-inner">
            <div class="card-face card-front">
              <div class="card-header"></div>

              <!-- overlapping initials avatar -->
              <div class="avatar">${initials}</div>

              <div class="card-body">
                <h3>${displayName}</h3>
                <div class="role">${p.course || ''}${p.college ? ' — ' + p.college : ''}</div>

                <div class="info">
                  ${address ? `<p><i class="fa-solid fa-location-dot"></i><small>${address}</small></p>` : ''}
                  ${cp ? `<p><i class="fa-solid fa-phone"></i><small>${cp}</small></p>` : ''}
                  ${email ? `<p><i class="fa-solid fa-envelope"></i><small>${email}</small></p>` : ''}
                </div>
              </div>

              <div class="card-footer">
                <div class="status-indicator ${completeClass}">${completeClass === 'complete' ? 'Complete' : 'Incomplete'}</div>
                <button type="button" class="view"><i class="fa-solid fa-eye"></i> View</button>
              </div>
            </div>

            <div class="card-face card-back">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:800;">Details</div>
                <button class="view" style="border-radius:8px;padding:0.4rem 0.6rem;font-weight:700;">Back</button>
              </div>

              <div class="back-grid">
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Batch</div><div>${p.batch || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Birthday</div><div>${formatBirthday(p.birthday) || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Age</div><div>${age !== null ? age : '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Gender</div><div>${p.gender || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Position</div><div>${p.designation || '—'}</div></div>
                <div class="back-item"><div style="font-size:0.75rem;color:var(--text-muted);">Job</div><div>${p.job || '—'}</div></div>
              </div>

              <div style="margin-top:auto; padding-top:0.75rem;">
                <div style="font-size:0.8rem; color:var(--text-muted);">Tap <strong>Back</strong> or the eye button to return.</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCards(dataArray){
      if(!cardsContainer) return;
      cardsContainer.innerHTML = '';
      if(!Array.isArray(dataArray) || dataArray.length === 0){
        cardsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-folder-open" style="font-size:3rem; opacity:0.6;"></i>
            <div class="empty-title" style="font-weight:800; margin-top:0.5rem;">No Data Available</div>
            <div class="empty-sub" style="opacity:0.8;">No alumni records match your current filter or search.</div>
          </div>
        `;
        const statsEl = document.querySelector('.stats-grid');
        if(statsEl) statsEl.style.opacity = "0.45";
        updateStats([]);
        return;
      }
      const statsEl = document.querySelector('.stats-grid');
      if(statsEl) statsEl.style.opacity = "1";
      cardsContainer.innerHTML = dataArray.map(renderCard).join('');
      attachCardListeners();
      updateStats(filteredData);
    }

    function updateStats(displayArray){
      const dataArray = Array.isArray(displayArray) ? displayArray : (filteredData || []);
      const total = dataArray.length;
      const male = dataArray.filter(d => safeLower(d.gender || '').startsWith('m')).length;
      const female = dataArray.filter(d => safeLower(d.gender || '').startsWith('f')).length;
      const completeCount = dataArray.filter(d => computeCompleteStatus(d) === 'complete').length;
      const incompleteCount = dataArray.filter(d => computeCompleteStatus(d) === 'incomplete').length;

      const statTotal = document.querySelector('#stat-total');
      const statComplete = document.querySelector('#stat-complete');
      const statMale = document.querySelector('#stat-male');
      const statFemale = document.querySelector('#stat-female');

      if(statTotal) statTotal.innerText = total;
      if(statComplete) statComplete.innerText = `${completeCount} / ${incompleteCount}`;
      if(statMale) statMale.innerText = male;
      if(statFemale) statFemale.innerText = female;
    }

    /* ---------- Card listeners (flip behavior, no message or status clicks) ---------- */
    function attachCardListeners(){
      // View / Back buttons flip
      document.querySelectorAll('.card .view').forEach(btn=>{
        btn.onclick = (e)=>{
          const cardRoot = btn.closest('.card');
          if(!cardRoot) return;
          cardRoot.classList.toggle('flipped');
        };
      });
    }

    /* ---------- Modals ---------- */
    function openModal(id){
      const m = document.getElementById(id);
      if(!m) return;
      m.style.display = 'flex';
      m.classList.add('active');
      m.setAttribute('aria-hidden','false');
    }

    function closeModalAll(){
      document.querySelectorAll('.modal-overlay').forEach(m => {
        m.style.display = 'none';
        m.classList.remove('active');
        m.setAttribute('aria-hidden','true');
      });
    }

    document.addEventListener('click', function(e){
      if(e.target.classList && e.target.classList.contains('modal-close')) { closeModalAll(); return; }
      if(e.target.classList && e.target.classList.contains('modal-overlay')) { closeModalAll(); return; }
    });

    /* ---------- Filtering ---------- */
    function applyFilters(){
      const qRaw = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
      const q = safeLower(qRaw);
      const batchV = batchSelect ? safeLower(batchSelect.value || '') : '';
      const collegeV = collegeSelect ? safeLower(collegeSelect.value || '') : '';
      const courseV = courseSelect ? safeLower(courseSelect.value || '') : '';
      const municipalityV = municipalitySelect ? safeLower(municipalitySelect.value || '') : '';
      const birthmonthV = birthmonthSelect ? String(birthmonthSelect.value) : '';
      const statusV = statusFilter ? safeLower(statusFilter.value || '') : '';

      filteredData = allData.filter(p=>{
        const first = safeLower(p.firstname || '');
        const middle = safeLower(p.middlename || '');
        const last = safeLower(p.surname || '');
        const nameVariants = [
          `${first} ${middle} ${last}`.replace(/\s+/g,' ').trim(),
          `${first} ${last}`.replace(/\s+/g,' ').trim(),
          `${last} ${first} ${middle}`.replace(/\s+/g,' ').trim(),
          `${last}, ${first}`.replace(/\s+/g,' ').trim(),
          `${first}${last}`.replace(/\s+/g,'').trim()
        ];
        const otherFields = `${safeLower(p.email || '')} ${safeLower(p.course || '')} ${safeLower(p.college || '')} ${safeLower(String(p.municipality || ''))} ${safeLower(String(p.birthmonth || ''))}`.trim();

        if(q){
          const matchesName = nameVariants.some(v => v.includes(q));
          const matchesOther = otherFields.includes(q);
          if(!matchesName && !matchesOther) return false;
        }

        if(batchV && safeLower(p.batch || '') !== batchV) return false;
        if(collegeV && safeLower(p.college || p.campus || '') !== collegeV) return false;
        if(courseV && safeLower(p.course || '') !== courseV) return false;
        if(municipalityV && safeLower(String(p.municipality || '')) !== municipalityV) return false;

        if(birthmonthV){
          if(/^\d+$/.test(birthmonthV)){
            const targetNum = parseInt(birthmonthV, 10);
            const personNum = p.birthmonthNum ? Number(p.birthmonthNum) : null;
            if(!personNum || personNum !== targetNum) return false;
          } else {
            if(safeLower(String(p.birthmonth || '')) !== safeLower(birthmonthV)) return false;
          }
        }

        if(statusV && safeLower(computeCompleteStatus(p)) !== statusV) return false;
        if(selectedLetter){
          const sname = safeLower(p.surname || '');
          if(!sname.startsWith(selectedLetter)) return false;
        }
        return true;
      });

      filteredData.sort(compareNames);
      renderCards(filteredData);
      updateAllSelectActiveStates();
      updateFilterHighlight();
      updateOptionButtons();
    }

    function updateFilterHighlight(){
      const anySearch = (searchInput && searchInput.value && searchInput.value.trim() !== '');
      const anySelect = (collegeSelect && collegeSelect.value && collegeSelect.value !== '') ||
                        (courseSelect && courseSelect.value && courseSelect.value !== '') ||
                        (municipalitySelect && municipalitySelect.value && municipalitySelect.value !== '') ||
                        (birthmonthSelect && birthmonthSelect.value && birthmonthSelect.value !== '') ||
                        (statusFilter && statusFilter.value && statusFilter.value !== '');
      const letterActive = !!selectedLetter;
      if(anySearch || anySelect || letterActive){
        sheetSelect && sheetSelect.classList.add('active');
      } else {
        sheetSelect && sheetSelect.classList.remove('active');
      }
    }

    /* ---------- UI wiring ---------- */
    if(searchInput) searchInput.addEventListener('input', ()=> applyFilters());
    if(batchSelect) batchSelect.addEventListener('change', ()=> { applyFilters(); updateSelectActive(batchSelect); });
    if(collegeSelect) collegeSelect.addEventListener('change', ()=> {
      const val = collegeSelect.value || '';
      if(!val){
        if(courseSelect){ courseSelect.style.display = 'none'; courseSelect.value = ''; }
        applyFilters();
        updateSelectActive(collegeSelect);
        return;
      }
      updateSelectActive(collegeSelect);
      populateCourseForCollege(val);
    });
    if(courseSelect) courseSelect.addEventListener('change', ()=> { updateSelectActive(courseSelect); applyFilters(); });
    if(municipalitySelect) municipalitySelect.addEventListener('change', ()=> { updateSelectActive(municipalitySelect); applyFilters(); });
    if(birthmonthSelect) birthmonthSelect.addEventListener('change', ()=> { updateSelectActive(birthmonthSelect); applyFilters(); });
    if(statusFilter) statusFilter.addEventListener('change', ()=> { updateSelectActive(statusFilter); applyFilters(); });

    if(btnMunicipality){
      btnMunicipality.addEventListener('click', ()=> openOptionModal('municipality'));
    }
    if(btnBirthmonth){
      btnBirthmonth.addEventListener('click', ()=> openOptionModal('birthmonth'));
    }

    if(btnReset){
      btnReset.addEventListener('click', ()=> {
        // reset search and filters
        if(searchInput) searchInput.value = '';
        if(batchSelect) batchSelect.value = '';
        if(collegeSelect) collegeSelect.value = '';
        if(courseSelect) { courseSelect.value = ''; courseSelect.style.display = 'none'; }
        if(municipalitySelect) municipalitySelect.value = '';
        if(birthmonthSelect) birthmonthSelect.value = '';
        if(statusFilter) statusFilter.value = '';
        // reset alphabet
        document.querySelectorAll('#alphabetContainer button').forEach(b=>b.classList.remove('active'));
        const allBtn = document.querySelector('#alphabetContainer button');
        if(allBtn) allBtn.classList.add('active');
        selectedLetter = '';
        updateAllSelectActiveStates();
        updateOptionButtons();
        applyFilters();
      });
    }

    /* ---------- Alphabet ---------- */
    function buildAlphabet(){
      if(!alphabetContainer) return;
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      alphabetContainer.innerHTML = '';
      const allBtn = document.createElement('button'); allBtn.type = 'button';
      allBtn.classList.add('active'); allBtn.innerText='All';
      allBtn.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(b=>b.classList.remove('active')); allBtn.classList.add('active'); selectedLetter = ''; applyFilters(); });
      alphabetContainer.appendChild(allBtn);
      letters.split('').forEach(l=>{
        const b = document.createElement('button'); b.type = 'button';
        b.innerText = l;
        b.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); selectedLetter = l.toLowerCase(); applyFilters(); });
        alphabetContainer.appendChild(b);
      });
    }

    /* ---------- Populate selects ---------- */
    function populateSelects(){
      function uniq(arr){ return [...new Set(arr.filter(x=>x !== undefined && x !== null && String(x).trim() !== ''))].sort(); }

      collegeCourseMap = {};
      allData.forEach(d=>{
        const col = d.college || d.campus || '';
        const crs = d.course || '';
        if(!col) return;
        const key = String(col).trim();
        if(!collegeCourseMap[key]) collegeCourseMap[key] = new Set();
        if(crs) collegeCourseMap[key].add(crs);
      });

      if(batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
      if(collegeSelect) collegeSelect.innerHTML = '<option value="">Select College</option>';
      if(courseSelect) courseSelect.innerHTML = '<option value="">Select Course</option>';
      if(municipalitySelect) municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
      if(birthmonthSelect) birthmonthSelect.innerHTML = '<option value="">Select BirthMonth</option>';

      uniq(allData.map(d => d.batch)).forEach(v=> batchSelect && (batchSelect.innerHTML += `<option>${v}</option>`));
      uniq(allData.map(d => d.college || d.campus)).forEach(v=> collegeSelect && (collegeSelect.innerHTML += `<option>${v}</option>`));
      uniq(allData.map(d => d.course)).forEach(v=> courseSelect && (courseSelect.innerHTML += `<option>${v}</option>`));

      const municipalities = uniq(allData.map(d => String(d.municipalityRaw || d.municipality || '').trim()));
      municipalities.forEach(v=> municipalitySelect && (municipalitySelect.innerHTML += `<option>${v}</option>`));

      const monthsPresent = new Set();
      allData.forEach(d => { if(d.birthmonthNum) monthsPresent.add(Number(d.birthmonthNum)); });
      const monthNums = Array.from(monthsPresent).sort((a,b)=>a-b);
      monthNums.forEach(num => {
        const name = monthNameFromNumber(num);
        birthmonthSelect && (birthmonthSelect.innerHTML += `<option value="${num}">${name}</option>`);
      });

      const rawBMStrings = uniq(allData.map(d => String(d.birthmonthRaw || '').trim()).filter(s=> s && !/^\d+$/.test(s)));
      rawBMStrings.forEach(s => {
        if(!monthNums.some(n => monthNameFromNumber(n).toLowerCase() === s.toLowerCase())){
          birthmonthSelect && (birthmonthSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }
      });

      if(courseSelect && courseSelect.value && courseSelect.value !== '') courseSelect.style.display = '';
      else if(courseSelect) courseSelect.style.display = 'none';

      if(municipalitySelect) municipalitySelect.style.display = 'none';
      if(birthmonthSelect) birthmonthSelect.style.display = 'none';

      updateFilterHighlight();
      updateOptionButtons();
    }

    /* ---------- Course selection ---------- */
    function populateCourseForCollege(collegeName){
      const set = collegeCourseMap[collegeName] || new Set();
      const arr = Array.from(set).sort();
      if(arr.length === 0){
        if(courseSelect){ courseSelect.style.display = 'none'; courseSelect.innerHTML = '<option value="">Select Course</option>'; courseSelect.value = ''; }
        applyFilters();
        return;
      }
      if(courseSelect) courseSelect.innerHTML = '<option value="">Select Course</option>';
      arr.forEach(c => {
        if(courseSelect){
          const opt = document.createElement('option');
          opt.value = c; opt.text = c; courseSelect.appendChild(opt);
        }
      });
      if(courseSelect) courseSelect.style.display = '';
      applyFilters();
    }

    /* ---------- Generic Option Modal ---------- */
    let currentOptionField = '';
    const optionClearBtn = document.getElementById('optionClearBtn');
    if(optionClearBtn){
      optionClearBtn.addEventListener('click', ()=>{ /* unused but kept for compatibility */ });
    }

    function openOptionModal(field){
      currentOptionField = field;
      if(!optionListEl) return;
      optionListEl.innerHTML = '';
      if(optionFallback) optionFallback.style.display = 'none';

      const clearTop = document.createElement('button');
      clearTop.type = 'button';
      clearTop.className = 'option-btn option-clear-top';
      clearTop.innerText = 'Clear selection';
      clearTop.addEventListener('click', ()=> {
        if(field === 'municipality'){ municipalitySelect && (municipalitySelect.value = ''); updateSelectActive(municipalitySelect); }
        else if(field === 'birthmonth'){ birthmonthSelect && (birthmonthSelect.value = ''); updateSelectActive(birthmonthSelect); }
        closeModalAll();
        applyFilters();
      });

      if(field === 'municipality'){
        if(optionModalTitle) optionModalTitle.innerText = 'Select Municipality';
        if(optionModalDesc) optionModalDesc.innerText = 'Choose a municipality to filter by:';
        const vals = [...new Set(allData.map(d => String(d.municipalityRaw || d.municipality || '').trim()).filter(Boolean))].sort();
        if(vals.length === 0){ if(optionFallback) optionFallback.style.display = ''; openModal('optionModal'); return; }
        optionListEl.appendChild(clearTop);
        vals.forEach(v=>{
          const b = document.createElement('button'); b.type = 'button'; b.className = 'option-btn'; b.innerText = v;
          b.addEventListener('click', ()=>{ municipalitySelect.value = v; updateSelectActive(municipalitySelect); closeModalAll(); applyFilters(); });
          optionListEl.appendChild(b);
        });
        openModal('optionModal');
        return;
      }

      if(field === 'birthmonth'){
        if(optionModalTitle) optionModalTitle.innerText = 'Select Birth Month';
        if(optionModalDesc) optionModalDesc.innerText = 'Choose a birth month to filter by:';
        const monthNums = [...new Set(allData.map(d => d.birthmonthNum).filter(Boolean))].sort((a,b)=>a-b);
        if(monthNums.length === 0){ if(optionFallback) optionFallback.style.display = ''; openModal('optionModal'); return; }
        optionListEl.appendChild(clearTop);
        monthNums.forEach(n=>{
          const name = monthNameFromNumber(n);
          const b = document.createElement('button'); b.type = 'button'; b.className = 'option-btn'; b.innerText = name;
          b.addEventListener('click', ()=>{ birthmonthSelect.value = String(n); updateSelectActive(birthmonthSelect); closeModalAll(); applyFilters(); });
          optionListEl.appendChild(b);
        });
        openModal('optionModal');
        return;
      }
    }

    /* ---------- Select active visuals ---------- */
    function updateSelectActive(selectEl){ if(!selectEl) return; if(selectEl.value && selectEl.value !== '') selectEl.classList.add('active'); else selectEl.classList.remove('active'); }
    function updateAllSelectActiveStates(){ [collegeSelect, courseSelect, batchSelect, municipalitySelect, birthmonthSelect, statusFilter].forEach(updateSelectActive); updateFilterHighlight(); }

    /* ---------- Option buttons reflect selections ---------- */
    function updateOptionButtons(){
      // municipality
      if(!btnMunicipality || !municipalitySelect) return;
      const val = municipalitySelect.value || '';
      if(val){
        btnMunicipality.innerText = val;
        btnMunicipality.classList.add('active');
      } else {
        btnMunicipality.innerText = 'Municipality';
        btnMunicipality.classList.remove('active');
      }
      // birthmonth
      if(!btnBirthmonth || !birthmonthSelect) return;
      const bval = birthmonthSelect.value || '';
      if(bval){
        // if bval is numeric, show month name
        if(/^\d+$/.test(String(bval))) btnBirthmonth.innerText = monthNameFromNumber(Number(bval));
        else btnBirthmonth.innerText = String(bval);
        btnBirthmonth.classList.add('active');
      } else {
        btnBirthmonth.innerText = 'Birth Month';
        btnBirthmonth.classList.remove('active');
      }
    }

    /* ---------- Reload / init ---------- */
    async function reloadAll(sheetName){
      showLoading();
      try {
        const raw = await fetchAllFromServer(sheetName);
        allData = raw || [];
        allData.sort(compareNames);
        populateSelects();
        buildAlphabet();
        applyFilters();
      } catch(err){
        console.error('Reload failed', err);
        if(cardsContainer) cardsContainer.innerHTML = `<p style="color:#a00">Unable to load alumni data. ${err.message || ''}</p>`;
      } finally {
        hideLoading();
      }
    }

    /* ---------- CSV Export ---------- */
    function escapeCSV(value){ if(value === null || value === undefined) return ''; const s = String(value); if(s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"'; return s; }
    function exportToCSV(data){
      if(!Array.isArray(data)) data = [];
      const headers = ['Surname','First Name','Middle Name','Birthdate','Gender','Address','CpNumber','Email','Position','Job'];
      const lines = [headers.join(',')];
      data.forEach(d=>{
        const row = [
          escapeCSV(d.surname || ''),
          escapeCSV(d.firstname || ''),
          escapeCSV(d.middlename || ''),
          escapeCSV(d.birthday || ''),
          escapeCSV(d.gender || ''),
          escapeCSV(d.address || ''),
          escapeCSV(d.cpnumber || ''),
          escapeCSV(d.email || ''),
          escapeCSV(d.designation || d.position || ''),
          escapeCSV(d.job || '')
        ];
        lines.push(row.join(','));
      });
      const csv = lines.join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `alumni_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    if(exportBtnTop) exportBtnTop.addEventListener('click', ()=>{ const dataToExport = Array.isArray(filteredData) && filteredData.length >= 0 ? filteredData : allData; exportToCSV(dataToExport); });

    /* ---------- Sheet select handling ---------- */
    if(sheetSelect) sheetSelect.addEventListener('change', (e)=>{
      const val = sheetSelect.value || '2025';
      if(val === 'Alumni Management Directory') return;
      currentSheet = val;
      reloadAll(currentSheet);
    });

    /* ---------- Init ---------- */
    (function init(){
      currentSheet = sheetSelect && sheetSelect.value && sheetSelect.value !== 'Alumni Management Directory' ? sheetSelect.value : '2025';
      buildAlphabet();
      // initial load (wrap in try/catch to avoid unhandled rejection in dev)
      reloadAll(currentSheet).catch(err => console.warn('Initial load error', err));
    })();
    </script>
</body>
</html>
