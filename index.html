<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Alumni Management Directory</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
/* ---------- CSS (mostly unchanged) ---------- */
*{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif}
body{margin:0;background:#f3f5f7;color:#333}
.container{padding:25px 40px}
.title-row{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:15px;position:relative}
.title-area{display:flex;align-items:center;gap:12px}
.title{font-size:22px;font-weight:600;display:flex;align-items:center;gap:12px}
.batch-dropdown{position:relative}
.batch-btn{background:#fff;border:1px solid #e6eef6;padding:8px 12px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.batch-menu{position:absolute;right:0;top:44px;background:white;border:1px solid #e6eaf2;border-radius:8px;box-shadow:0 10px 30px rgba(2,6,23,0.08);min-width:180px;z-index:50;padding:8px;max-height:260px;overflow:auto}
.batch-menu button{width:100%;text-align:left;padding:8px;border-radius:6px;border:none;background:transparent;cursor:pointer}
.batch-menu button:hover{background:#f3f7fb}
.export-btn{background:#06b6d4;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.search{width:260px;padding:10px 14px;border-radius:6px;border:1px solid #dcdcdc;background:white}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:25px}
.stat-card{background:white;padding:25px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.05)}
.stat-card h2{margin:10px 0 5px}
.icon{font-size:26px;width:55px;height:55px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:auto;color:white}
.blue{background:#3b82f6} .green{background:#22c55e} .yellow{background:#f59e0b} .cyan{background:#06b6d4}
.filters{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.tabs button{padding:8px 14px;border:1px solid #d8d8d8;background:white;border-radius:6px;cursor:pointer}
.tabs .active{background:#3b82f6;color:white}
.department{padding:8px;border-radius:6px;border:1px solid #ccc;background:white;cursor:pointer}
.department.active{border-color:#3b82f6;box-shadow:0 4px 14px rgba(59,130,246,0.12);}
.alphabet{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
.alphabet button{border:1px solid #d8d8d8;background:white;padding:6px 10px;border-radius:5px;cursor:pointer}
.alphabet .active{background:#3b82f6;color:white}
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:25px}
.card{background:white;padding:18px;border-radius:14px;box-shadow:0 6px 20px rgba(15,23,42,0.06);position:relative;text-align:left;min-height:170px;overflow:hidden}
.avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;margin-bottom:10px;float:right;border:3px solid rgba(0,0,0,0.04)}
.initials{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;float:right;border:3px solid rgba(0,0,0,0.04);font-size:22px}
.card h3{margin:0 0 6px;font-size:16px}
.role{color:#6b7280;margin-bottom:8px}
.info{text-align:left;font-size:14px;color:#555;margin-bottom:10px}
.info p{margin:6px 0;display:flex;align-items:center;gap:8px}
.badge{position:absolute;right:15px;top:15px;padding:6px 10px;border-radius:12px;font-size:12px;color:white;box-shadow:0 3px 8px rgba(0,0,0,0.08)}
.team{background:#16a34a} .client{background:#2563eb}
.actions{display:flex;gap:8px;margin-top:8px;align-items:center}
.actions button{padding:9px;border-radius:8px;border:1px solid #e2e8f0;background:white;cursor:pointer;min-width:74px;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.view{background:#f0f7ff;border-color:#cfe6ff;color:#024eca}
.message{background:#f6fffa;border-color:#e2fbeb;color:#0b8b4a}
.actions .status-select{padding:8px 10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;font-weight:600;min-width:120px;}
.actions .status-select.complete{background:#16a34a;color:white;border-color:#16a34a}
.actions .status-select.incomplete{background:#ef4444;color:white;border-color:#ef4444}

/* Allow modal content to scroll when tall */
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.55);justify-content:center;align-items:center;z-index:999}
.modal-content{
  background:linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  padding:0;border-radius:12px;min-width:320px;max-width:90%;
  box-shadow:0 20px 50px rgba(2,6,23,0.35);
  /* allow scroll for tall content */
  max-height:90vh; overflow:auto;
  transform:translateY(6px);transition:transform .18s ease,opacity .18s ease;
}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(15,23,42,0.06)}
.modal-header h3{margin:0;font-size:18px}
.modal-body{padding:18px 20px;color:#334155;font-size:14px}
.modal-body .row{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px}
.modal-body p{margin:0}
.modal-footer{display:flex;gap:12px;padding:16px 20px;border-top:1px solid rgba(15,23,42,0.04);background:transparent}
.btn{padding:10px 14px;border-radius:8px;border:1px solid transparent;cursor:pointer;font-weight:600}
.btn-primary{background:#0ea5e9;color:white}
.btn-muted{background:white;border:1px solid #e6eef6;color:#0b6b9a}

/* make course & option lists scrollable when long */
.course-list, .option-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:360px;overflow:auto;padding-right:6px}
.course-list button, .option-list button{padding:10px;border-radius:8px;border:1px solid #e6e6e6;background:white;cursor:pointer;text-align:left}
.course-list button:hover, .option-list button:hover{background:#f5fbff}

/* style for the quick-clear button inside the option modal */
.option-clear-top{
  background:#fff6f6;border:1px solid #ffd7d7;color:#bb1f1f;font-weight:700;padding:10px;border-radius:8px;margin-bottom:6px;cursor:pointer;text-align:left;
}

/* NO DATA card styling */
.no-data-card{display:flex;align-items:center;justify-content:center;height:140px;font-weight:700;color:#9ca3af;font-size:20px;background:linear-gradient(180deg,#fff 0%,#fbfbfb 100%);border:2px dashed #e5e7eb;border-radius:12px}
.empty-state {grid-column: 1 / -1;display: flex;justify-content: center;align-items: center;padding: 70px 20px;}
.empty-box{background:white;border-radius:16px;padding:50px 40px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.08);max-width:420px;width:100%;animation:fadeIn .25s ease;}
.empty-icon{font-size:60px;color:#cbd5e1;margin-bottom:12px;}
.empty-title{font-size:22px;font-weight:700;color:#374151;margin-bottom:6px;}
.empty-sub{color:#6b7280;font-size:14px;}
.modal-body textarea{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px}
@media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
@media (max-width:600px){.cards{grid-template-columns:1fr}.filters{flex-direction:column;align-items:stretch}.modal-content{min-width:320px}}
</style>
</head>
<body>

<div class="container">

    <!-- Title + Export button aligned right -->
    <div class="title-row">
      <div class="title-area">
        <h2 class="title" id="mainTitle">Alumni Management Directory</h2>

        <!-- Batch dropdown (interactive title-level dropdown) -->
        <div class="batch-dropdown" id="batchDropdownWrap" aria-haspopup="true">
          <button id="batchDropdownBtn" class="batch-btn" aria-expanded="false" title="Select batch">
            <i class="fa-solid fa-graduation-cap"></i>
            <span id="batchDropdownLabel">All Batches</span>
            <i class="fa-solid fa-caret-down" style="opacity:0.6"></i>
          </button>
          <div id="batchDropdownMenu" class="batch-menu" style="display:none" role="menu" aria-label="Batch options">
            <!-- options filled by JS -->
          </div>
        </div>
      </div>

      <div>
        <button id="exportBtnTop" class="export-btn" title="Export current data to CSV">
          <i class="fa-solid fa-file-export"></i> Export CSV
        </button>
      </div>
    </div>

    <!-- FILTER BAR (search + filters) -->
    <div class="filters">
        <input type="text" class="search" placeholder="Search contacts..." aria-label="Search contacts">

        <div class="tabs" style="display:flex;gap:8px;">
            <button type="button" class="active">All Contacts</button>
            <button type="button">Female</button>
            <button type="button">Male</button>
            <button type="button">BirthMonth</button>
            <button type="button">Municipality</button>
        </div>

        <!-- keep batchSelect available as hidden storage (batch dropdown is now primary) -->
        <select id="batchSelect" class="department" aria-label="Batch" style="display:none;">
            <option value="">Select Batch</option>
        </select>

        <select id="collegeSelect" class="department" aria-label="College">
            <option value="">Select College</option>
        </select>

        <!-- courseSelect will be set by course modal -->
        <select id="courseSelect" class="department" aria-label="Course" style="display:none;">
            <option value="">Select Course</option>
        </select>

        <!-- hidden selects used to hold the chosen municipality/birthmonth values -->
        <select id="municipalitySelect" class="department" aria-label="Municipality" style="display:none;">
            <option value="">Select Municipality</option>
        </select>

        <select id="birthmonthSelect" class="department" aria-label="BirthMonth" style="display:none;">
            <option value="">Select BirthMonth</option>
        </select>

        <select id="statusFilter" class="department" aria-label="Completion status">
            <option value="">All Status</option>
            <option value="complete">Complete</option>
            <option value="incomplete">Incomplete</option>
        </select>
    </div>

    <!-- ALPHABET FILTER -->
    <div class="alphabet" id="alphabetContainer" aria-hidden="false" role="group"></div>

    <!-- STATS -->
    <div class="stats" style="margin-top:10px;">
        <div class="stat-card">
            <div class="icon blue"><i class="fa-solid fa-users"></i></div>
            <h2>0</h2>
            <p>Total Graduates</p>
        </div>
        <div class="stat-card">
            <div class="icon green"><i class="fa-solid fa-user"></i></div>
            <h2>0</h2>
            <p>Contacts (Complete / Incomplete)</p>
        </div>
        <div class="stat-card">
            <div class="icon yellow"><i class="fa-solid fa-mars-and-venus"></i></div>
            <h2>0</h2>
            <p>Male</p>
        </div>
        <div class="stat-card">
            <div class="icon cyan"><i class="fa-solid fa-venus-mars"></i></div>
            <h2>0</h2>
            <p>Female</p>
        </div>
    </div>

    <!-- CONTACT CARDS -->
    <div class="cards" id="cardsContainer" aria-live="polite">
        <!-- rendered by JS -->
    </div>
</div>

<!-- COURSE CHOICE MODAL (shown when college selected) -->
<div class="modal" id="courseModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-content" role="document">
    <div class="modal-header">
      <h3>Select Course</h3>
      <button type="button" class="close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin:0 0 8px">Choose a course for the selected college:</p>
      <div id="courseList" class="course-list">
        <!-- buttons generated by JS -->
      </div>
      <div id="courseFallback" style="margin-top:12px;display:none">
        <p style="margin:6px 0;color:#9aa0a6">No courses available for this college.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-muted close">Cancel</button>
      <button type="button" class="btn btn-primary" id="courseClearBtn">Clear Course</button>
    </div>
  </div>
</div>

<!-- GENERIC OPTION MODAL (used for Municipality / BirthMonth) -->
<div class="modal" id="optionModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-content" role="document">
    <div class="modal-header">
      <h3 id="optionModalTitle">Choose</h3>
      <button type="button" class="close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="optionModalDesc" style="margin:0 0 8px">Choose an option:</p>
      <div id="optionList" class="option-list">
        <!-- generated by JS -->
      </div>
      <div id="optionFallback" style="margin-top:12px;display:none">
        <p style="margin:6px 0;color:#9aa0a6">No options available.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-muted close">Cancel</button>
      <button type="button" class="btn btn-primary" id="optionClearBtn">Clear</button>
    </div>
  </div>
</div>

<!-- VIEW MODAL (professional layout) -->
<div class="modal" id="viewModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-content" role="document">
    <div class="modal-header" style="align-items:center;gap:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <img id="modalAvatar" src="" alt="" style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid rgba(0,0,0,0.04)">
        <div>
          <h3 id="modalName" style="margin:0;font-size:16px">Name</h3>
          <div id="modalSub" style="color:#6b7280;font-size:13px">Course — College</div>
        </div>
      </div>
      <button type="button" class="close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="row"><strong>Birthday:</strong><p id="modalBirthday" style="margin-left:8px"></p></div>
          <div class="row"><strong>Gender:</strong><p id="modalGender" style="margin-left:8px"></p></div>
          <div class="row"><strong>Batch:</strong><p id="modalBatch" style="margin-left:8px"></p></div>
          <div class="row"><strong>Position:</strong><p id="modalPosition" style="margin-left:8px"></p></div>
        </div>
        <div>
          <div class="row"><strong>Address:</strong><p id="modalAddress" style="margin-left:8px"></p></div>
          <div class="row"><strong>Contact:</strong><p id="modalPhone" style="margin-left:8px"></p></div>
          <div class="row"><strong>Email:</strong><p id="modalEmail" style="margin-left:8px"></p></div>
          <div class="row"><strong>Job:</strong><p id="modalJob" style="margin-left:8px"></p></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-muted close">Close</button>
    </div>
  </div>
</div>

<!-- MESSAGE MODAL (professional layout) -->
<div class="modal" id="messageModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-content" role="document">
    <div class="modal-header">
      <h3>Send Message</h3>
      <button type="button" class="close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="messageRecipient" style="font-weight:600;margin-bottom:8px"></p>
      <label>Subject</label>
      <input type="text" id="msgSubject" placeholder="Subject" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-bottom:12px">
      <label>Message</label>
      <textarea id="msgBody" placeholder="Type your message"></textarea>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-muted close">Cancel</button>
      <button type="button" class="btn btn-primary" id="sendMessage">Send</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwdY0dw97G7MZHloXM9QqXPGrL_ks51oC7yAOGvwRo7p2p4Jcx_FTrzxvgNuQ9qO5Sf/exec';

/* ---------- Helpers ---------- */
function normalizeKey(s){ return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,''); }
function safeLower(v){ return String(v || '').toLowerCase(); }
function uid(){ return 'u_' + Date.now() + '_' + Math.floor(Math.random()*10000); }
function isBlankOrNA(value){
  if(value === null || value === undefined) return true;
  const s = String(value).trim();
  return s === '' || /^(-|n\/a|na)$/i.test(s);
}

/* Month utilities */
const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
function monthNumberFromAny(v){
  if(v === null || v === undefined) return null;
  if(typeof v === 'number' && !isNaN(v) && v >= 1 && v <= 12) return v;
  const s = String(v).trim();
  if(s === '') return null;
  if(/^\d{1,2}$/.test(s)){
    const n = parseInt(s,10);
    if(n >= 1 && n <= 12) return n;
  }
  const parsed = Date.parse(s);
  if(!isNaN(parsed)){
    const d = new Date(parsed);
    return d.getMonth() + 1;
  }
  const monthRegex = /(jan(uary)?|feb(ruary)?|mar(ch)?|apr(il)?|may|jun(e)?|jul(y)?|aug(ust)?|sep(t)?(ember)?|oct(ober)?|nov(ember)?|dec(ember)?)/i;
  const m = s.match(monthRegex);
  if(m){
    const found = m[0].toLowerCase();
    for(let i=0;i<MONTH_NAMES.length;i++){
      if(MONTH_NAMES[i].toLowerCase().startsWith(found)) return i+1;
    }
  }
  return null;
}
function monthNameFromNumber(num){
  const n = parseInt(num,10);
  if(isNaN(n) || n < 1 || n > 12) return '';
  return MONTH_NAMES[n-1];
}

/* format date to "MonthName D, YYYY" */
function formatBirthday(v){
  if(!v) return '';
  let d = null;
  if(typeof v === 'number') d = new Date(v);
  if(typeof v === 'string'){
    const s = v.trim();
    const iso = Date.parse(s);
    if(!isNaN(iso)) d = new Date(iso);
    else {
      const parts1 = s.split(/[\/\-\.\s]+/).map(p=>p.trim());
      if(parts1.length === 3){
        if(parts1[0].length === 4){
          const y = parseInt(parts1[0],10), m = parseInt(parts1[1],10)-1, day = parseInt(parts1[2],10);
          d = new Date(y,m,day);
        } else {
          const a = new Date(parseInt(parts1[2],10), parseInt(parts1[0],10)-1, parseInt(parts1[1],10));
          if(!isNaN(a)) d = a;
          else {
            const b = new Date(parseInt(parts1[2],10), parseInt(parts1[1],10)-1, parseInt(parts1[0],10));
            if(!isNaN(b)) d = b;
          }
        }
      }
    }
  }
  if(!d || isNaN(d)) return String(v);
  const monthNames = MONTH_NAMES;
  const m = monthNames[d.getMonth()];
  const day = d.getDate();
  const year = d.getFullYear();
  return `${m} ${day}, ${year}`;
}

/* determine complete status */
function computeCompleteStatus(person){
  const hasMiddle = !isBlankOrNA(person.middlename);
  const hasEmail = !isBlankOrNA(person.email);
  const hasPhone = !isBlankOrNA(person.cpnumber);
  if(hasMiddle && hasEmail && hasPhone) return 'complete';
  return 'incomplete';
}

/* ---------- DOM refs ---------- */
const cardsContainer = document.getElementById('cardsContainer');
const searchInput = document.querySelector('.search');
const tabButtons = document.querySelectorAll('.tabs button');
const alphabetContainer = document.getElementById('alphabetContainer');
const batchSelect = document.getElementById('batchSelect');
const collegeSelect = document.getElementById('collegeSelect');
const courseSelect = document.getElementById('courseSelect');
const municipalitySelect = document.getElementById('municipalitySelect');
const birthmonthSelect = document.getElementById('birthmonthSelect');
const statusFilter = document.getElementById('statusFilter');

const batchDropdownBtn = document.getElementById('batchDropdownBtn');
const batchDropdownMenu = document.getElementById('batchDropdownMenu');
const batchDropdownLabel = document.getElementById('batchDropdownLabel');

const exportBtnTop = document.getElementById('exportBtnTop');

const optionModal = document.getElementById('optionModal');
const optionListEl = document.getElementById('optionList');
const optionModalTitle = document.getElementById('optionModalTitle');
const optionModalDesc = document.getElementById('optionModalDesc');
const optionFallback = document.getElementById('optionFallback');
const optionClearBtn = document.getElementById('optionClearBtn');

let allData = []; // rows from server
let filteredData = [];
let selectedLetter = '';
let collegeCourseMap = {};

/* ---------- Server interaction ---------- */
async function fetchAllFromServer(){
  const res = await fetch(WEBAPP_URL);
  if(!res.ok) throw new Error('Failed to fetch from server');
  const data = await res.json();
  return data.map((r, idx) => {
    const rownum = r._row || r.row || r.rowNumber || r.rowNum;
    if(!r._uid) r._uid = r.id ? String(r.id) : uid();
    r._row = rownum;
    // normalize
    r.firstname = r.firstname || r.firstName || r.first || '';
    r.middlename = r.middlename || r.middleName || r.middle || '';
    r.surname = r.surname || r.lastName || r.last || '';
    r.cpnumber = r.cpnumber || r.phone || r.mobile || '';
    r.email = r.email || r.Email || '';
    r.college = r.college || r.campus || '';
    r.course = r.course || '';
    r.batch = r.batch || '';
    r.designation = r.designation || r.position || '';
    r.job = r.job || r.designation || '';
    r.address = r.address || r.Address || '';
    r.gender = r.gender || '';
    r.municipality = r.municipality || r.munic || r.city || r.town || r.muni || '';
    r.birthday = r.birthday || r.birthdate || r.dob || '';

    // ---- Integrate sheet's BirthMonth column robustly ----
    let rawBM = (r.birthmonth !== undefined && r.birthmonth !== null) ? r.birthmonth : '';
    const bmNumFromField = monthNumberFromAny(rawBM);
    if(bmNumFromField){
      r.birthmonthNum = bmNumFromField;
      r.birthmonth = monthNameFromNumber(bmNumFromField);
    } else {
      const bmNumFromBirthday = monthNumberFromAny(r.birthday);
      if(bmNumFromBirthday){
        r.birthmonthNum = bmNumFromBirthday;
        r.birthmonth = monthNameFromNumber(bmNumFromBirthday);
      } else {
        r.birthmonthNum = null;
        r.birthmonth = rawBM ? String(rawBM).trim() : '';
      }
    }

    r.complete = computeCompleteStatus(r);

    const hasRealPerson =
      !isBlankOrNA(r.firstname) ||
      !isBlankOrNA(r.surname) ||
      !isBlankOrNA(r.email);

    if(!hasRealPerson) return null;
    return r;
  }).filter(Boolean);
}

async function updateOnServer(row, data){
  const res = await fetch(WEBAPP_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ action:'update', row: row, data })
  });
  return res.json();
}

/* ---------- Sorting / rendering helpers ---------- */
function compareNames(a, b){
  const as = safeLower(a.surname || '');
  const bs = safeLower(b.surname || '');
  const af = safeLower(a.firstname || '');
  const bf = safeLower(b.firstname || '');
  if(as === '' && bs !== '') return 1;
  if(as !== '' && bs === '') return -1;
  if(as < bs) return -1;
  if(as > bs) return 1;
  if(af < bf) return -1;
  if(af > bf) return 1;
  return 0;
}
function avatarUrlFor(p){
  const surname = !isBlankOrNA(p.surname) ? p.surname : '';
  const firstname = !isBlankOrNA(p.firstname) ? p.firstname : '';
  const nameForAvatar = surname ? (firstname ? `${surname} ${firstname}` : surname) : (firstname || '');
  if(!nameForAvatar) return `https://ui-avatars.com/api/?background=random`;
  return `https://ui-avatars.com/api/?name=${encodeURIComponent(nameForAvatar)}&background=random`;
}
function initialsFor(p){
  const surname = !isBlankOrNA(p.surname) ? p.surname : '';
  const firstname = !isBlankOrNA(p.firstname) ? p.firstname : '';
  const s = surname ? surname.charAt(0).toUpperCase() : '';
  const f = firstname ? firstname.charAt(0).toUpperCase() : '';
  return (s + f) || (p.firstname ? p.firstname.charAt(0).toUpperCase() : 'A');
}

function renderCard(p){
  const hasAny = !(
    isBlankOrNA(p.firstname) &&
    isBlankOrNA(p.middlename) &&
    isBlankOrNA(p.surname) &&
    isBlankOrNA(p.email) &&
    isBlankOrNA(p.cpnumber) &&
    isBlankOrNA(p.address) &&
    isBlankOrNA(p.gender) &&
    isBlankOrNA(p.course) &&
    isBlankOrNA(p.college) &&
    isBlankOrNA(p.batch)
  );
  if(!hasAny) return '';
  const surname = isBlankOrNA(p.surname) ? '' : p.surname;
  const firstname = isBlankOrNA(p.firstname) ? '' : p.firstname;
  const middlename = isBlankOrNA(p.middlename) ? '' : p.middlename;
  const displayName = surname ? `${surname}, ${firstname}${middlename ? ' ' + middlename : ''}` : `${firstname} ${middlename}`.trim() || 'Unknown';
  const completeClass = computeCompleteStatus(p) === 'complete' ? 'complete' : 'incomplete';
  const gender = p.gender || 'Not specified';
  const address = p.address || 'No address provided';
  const cp = p.cpnumber || 'No contact number';
  const email = p.email || 'No email';
  const avatarUrl = avatarUrlFor(p);
  const initials = initialsFor(p);
  const dataEmail = email ? String(email).replace(/"/g,'&quot;') : '';
  const dataPhone = cp ? String(cp).replace(/"/g,'&quot;') : '';

  return `
    <div class="card" data-uid="${p._uid}" data-row="${p._row || ''}"
         data-surname="${safeLower(surname)}" data-gender="${safeLower(gender)}" data-batch="${safeLower(p.batch||'') }"
         data-college="${safeLower(p.college||'')}" data-course="${safeLower(p.course||'')}" data-complete="${safeLower(computeCompleteStatus(p))}"
         data-email="${dataEmail}" data-phone="${dataPhone}" data-college-display="${p.college || ''}" data-course-display="${p.course || ''}"
         data-position="${p.designation || ''}" data-address="${address}" data-job="${p.job || ''}" data-birthday="${(p.birthday || '')}">
      <img src="${avatarUrl}" class="avatar" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
      <div class="initials" style="display:none;background:#3b82f6">${initials}</div>
      <h3>${displayName}</h3>

      <div class="info">
        ${gender ? `<p><i class="fa-solid fa-venus-mars"></i>${gender}</p>` : ''}
        ${address ? `<p><i class="fa-solid fa-location-dot"></i>${address}</p>` : ''}
        ${cp ? `<p><i class="fa-solid fa-phone"></i>${cp}</p>` : ''}
        ${email ? `<p><i class="fa-solid fa-envelope"></i>${email}</p>` : ''}
      </div>

      <div class="actions">
        <button type="button" class="view"><i class="fa-solid fa-eye"></i> View</button>
        <button type="button" class="message"><i class="fa-solid fa-comment-dots"></i> Message</button>

        <select class="status-select ${completeClass}" data-uid="${p._uid}">
          <option value="complete"${(computeCompleteStatus(p) === 'complete') ? ' selected' : ''}>Complete</option>
          <option value="incomplete"${(computeCompleteStatus(p) === 'incomplete') ? ' selected' : ''}>Incomplete</option>
        </select>
      </div>
    </div>
  `;
}

function renderCards(dataArray){
  cardsContainer.innerHTML = '';
  if(!Array.isArray(dataArray) || dataArray.length === 0){
    cardsContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-box">
          <div class="empty-icon"><i class="fa-solid fa-folder-open"></i></div>
          <div class="empty-title">No Data Available</div>
          <div class="empty-sub">No alumni records match your current filter or search.</div>
        </div>
      </div>
    `;
    const statsEl = document.querySelector('.stats');
    if(statsEl) statsEl.style.opacity = "0.35";
    updateStats([]);
    return;
  }
  const statsEl = document.querySelector('.stats');
  if(statsEl) statsEl.style.opacity = "1";
  cardsContainer.innerHTML = dataArray.map(renderCard).join('');
  attachCardListeners();
  updateStats(filteredData);
}

function updateStats(displayArray){
  const dataArray = Array.isArray(displayArray) ? displayArray : (filteredData || []);
  const total = dataArray.length;
  const male = dataArray.filter(d => safeLower(d.gender || '').startsWith('m')).length;
  const female = dataArray.filter(d => safeLower(d.gender || '').startsWith('f')).length;
  const completeCount = dataArray.filter(d => computeCompleteStatus(d) === 'complete').length;
  const incompleteCount = dataArray.filter(d => computeCompleteStatus(d) === 'incomplete').length;
  const statH2s = document.querySelectorAll('.stat-card h2');
  if(statH2s.length >= 4){
    statH2s[0].innerText = total;
    statH2s[1].innerText = `${completeCount} / ${incompleteCount}`;
    statH2s[2].innerText = male;
    statH2s[3].innerText = female;
  }
}

/* ---------- Card listeners (View/Message/Status) ---------- */
function attachCardListeners(){
  document.querySelectorAll('.status-select').forEach(sel=>{
    sel.onchange = async (e)=>{
      const newVal = e.target.value === 'complete' ? 'complete' : 'incomplete';
      const card = e.target.closest('.card');
      if(!card) return;
      const row = card.dataset.row;
      const uid = card.dataset.uid;
      const person = allData.find(x => String(x._uid) === String(uid));
      if(person){
        person.complete = newVal;
        const selectEl = card.querySelector('.status-select');
        selectEl.classList.remove('complete','incomplete');
        selectEl.classList.add(newVal);
        if(newVal === 'complete'){
          const hasMiddle = !isBlankOrNA(person.middlename);
          const hasEmail = !isBlankOrNA(person.email);
          const hasPhone = !isBlankOrNA(person.cpnumber);
          if(!(hasMiddle && hasEmail && hasPhone)){
            if(!confirm('This person is missing middle name, email, or phone. Setting status to COMPLETE may be inconsistent. Continue?')) {
              person.complete = computeCompleteStatus(person);
              selectEl.value = person.complete;
              selectEl.classList.remove('complete','incomplete');
              selectEl.classList.add(person.complete);
              return;
            }
          }
        }
      }
      if(row){
        try {
          await updateOnServer(row, { ...person });
          await reloadAll();
        } catch(err){
          console.error('Update failed', err);
          alert('Update failed');
        }
      } else {
        applyFilters();
      }
    };
  });

  document.querySelectorAll('.view').forEach(btn=>{
    btn.onclick = (e)=>{
      const el = e.target;
      const card = el.closest('.card');
      if(!card) return;
      const uid = card.dataset.uid;
      const person = allData.find(x => String(x._uid) === String(uid)) || {};

      // Set main fields safely
      const name = card.querySelector('h3') ? card.querySelector('h3').innerText : (person.firstname || person.surname || 'Unknown');
      document.getElementById('modalName').innerText = name;
      document.getElementById('modalAvatar').src = avatarUrlFor(person);

      // Put course & college together into the subline
      const courseDisplay = card.dataset.courseDisplay || (person.course || '');
      const collegeDisplay = card.dataset.collegeDisplay || (person.college || person.campus || '');
      document.getElementById('modalSub').innerText = `${courseDisplay || '—'}${courseDisplay && collegeDisplay ? ' — ' : ''}${collegeDisplay || ''}`;

      // Fill remaining modal fields (use safe fallbacks)
      const rawBirthday = card.dataset.birthday || (person.birthday || '');
      document.getElementById('modalBirthday').innerText = rawBirthday ? formatBirthday(rawBirthday) : '';
      document.getElementById('modalGender').innerText = card.dataset.gender || (person.gender || '');
      document.getElementById('modalAddress').innerText = card.dataset.address || (person.address || '');
      document.getElementById('modalPhone').innerText = card.dataset.phone || (person.cpnumber || '');
      document.getElementById('modalEmail').innerText = card.dataset.email || (person.email || '');
      document.getElementById('modalBatch').innerText = person.batch || '';
      document.getElementById('modalPosition').innerText = card.dataset.position || (person.designation || '');
      document.getElementById('modalJob').innerText = card.dataset.job || (person.job || '');

      openModal('viewModal');
    };
  });

  document.querySelectorAll('.message').forEach(btn=>{
    btn.onclick = (e)=>{
      const card = e.target.closest('.card');
      if(!card) return;
      const personName = card.querySelector('h3') ? card.querySelector('h3').innerText : '';
      const email = card.dataset.email || '';
      document.getElementById('messageRecipient').innerText = `${personName}${email ? ' — ' + email : ''}`;
      document.getElementById('msgSubject').value = '';
      document.getElementById('msgBody').value = '';
      openModal('messageModal');
    };
  });
}

/* ---------- Modals ---------- */
function openModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
}
function closeModalAll(){
  document.querySelectorAll('.modal').forEach(m => {
    m.style.display = 'none';
    m.setAttribute('aria-hidden','true');
  });
}
document.addEventListener('click', function(e){
  if(e.target.classList && e.target.classList.contains('close')) { closeModalAll(); return; }
  if(e.target.classList && e.target.classList.contains('modal')) { closeModalAll(); return; }
});
document.getElementById('sendMessage').addEventListener('click', ()=>{
  const subj = document.getElementById('msgSubject').value;
  const body = document.getElementById('msgBody').value;
  if(!subj && !body){ alert('Please add a subject or message.'); return; }
  alert('Message sent (demo).');
  closeModalAll();
});

/* ---------- Filtering (central) ---------- */
function applyFilters(){
  const qRaw = searchInput.value.trim();
  const q = safeLower(qRaw);
  const batchV = safeLower(batchSelect.value || '');
  const collegeV = safeLower(collegeSelect.value || '');
  const courseV = safeLower(courseSelect.value || '');
  const municipalityV = safeLower(municipalitySelect.value || '');
  const birthmonthV = birthmonthSelect.value ? String(birthmonthSelect.value) : '';
  const statusV = safeLower(statusFilter.value || '');
  const activeTabBtn = Array.from(tabButtons).find(b => b.classList.contains('active'));
  const activeTab = activeTabBtn ? activeTabBtn.innerText : 'All Contacts';

  filteredData = allData.filter(p=>{
    const first = safeLower(p.firstname || '');
    const middle = safeLower(p.middlename || '');
    const last = safeLower(p.surname || '');
    const nameVariants = [
      `${first} ${middle} ${last}`.replace(/\s+/g,' ').trim(),
      `${first} ${last}`.replace(/\s+/g,' ').trim(),
      `${last} ${first} ${middle}`.replace(/\s+/g,' ').trim(),
      `${last}, ${first}`.replace(/\s+/g,' ').trim(),
      `${first}${last}`.replace(/\s+/g,'').trim()
    ];
    const otherFields = `${safeLower(p.email || '')} ${safeLower(p.course || '')} ${safeLower(p.college || '')} ${safeLower(String(p.municipality || ''))} ${safeLower(String(p.birthmonth || ''))}`.trim();

    if(q){
      const matchesName = nameVariants.some(v => v.includes(q));
      const matchesOther = otherFields.includes(q);
      if(!matchesName && !matchesOther) return false;
    }

    if(batchV && safeLower(p.batch || '') !== batchV) return false;
    if(collegeV && safeLower(p.college || p.campus || '') !== collegeV) return false;
    if(courseV && safeLower(p.course || '') !== courseV) return false;
    if(municipalityV && safeLower(String(p.municipality || '')) !== municipalityV) return false;

    if(birthmonthV){
      const targetNum = parseInt(birthmonthV, 10);
      const personNum = p.birthmonthNum ? Number(p.birthmonthNum) : null;
      if(!personNum || personNum !== targetNum) return false;
    }

    if(statusV && safeLower(computeCompleteStatus(p)) !== statusV) return false;
    if(activeTab === 'Male' && !safeLower(p.gender || '').startsWith('m')) return false;
    if(activeTab === 'Female' && !safeLower(p.gender || '').startsWith('f')) return false;
    if(activeTab === 'Incomplete' && safeLower(computeCompleteStatus(p)) !== 'incomplete') return false;
    if(activeTab === 'Complete' && safeLower(computeCompleteStatus(p)) !== 'complete') return false;
    if(selectedLetter){
      const sname = safeLower(p.surname || '');
      if(!sname.startsWith(selectedLetter)) return false;
    }
    return true;
  });

  filteredData.sort(compareNames);
  renderCards(filteredData);
  updateAllSelectActiveStates();
}

/* ---------- UI wiring ---------- */
searchInput.addEventListener('input', ()=> applyFilters());
batchSelect.addEventListener('change', ()=> {
  applyFilters();
  updateSelectActive(batchSelect);
  const v = batchSelect.value || '';
  batchDropdownLabel.innerText = v ? v : 'All Batches';
});
collegeSelect.addEventListener('change', ()=> {
  const val = collegeSelect.value || '';
  if(!val){
    courseSelect.style.display = 'none';
    courseSelect.value = '';
    applyFilters();
    updateSelectActive(collegeSelect);
    return;
  }
  updateSelectActive(collegeSelect);
  openCourseSelectionModal(val);
});
courseSelect.addEventListener('change', ()=> { updateSelectActive(courseSelect); applyFilters(); });
municipalitySelect.addEventListener('change', ()=> { updateSelectActive(municipalitySelect); applyFilters(); });
birthmonthSelect.addEventListener('change', ()=> { updateSelectActive(birthmonthSelect); applyFilters(); });
statusFilter.addEventListener('change', ()=> { updateSelectActive(statusFilter); applyFilters(); });

tabButtons.forEach(btn=> btn.addEventListener('click', function(){
  tabButtons.forEach(b=>b.classList.remove('active'));
  this.classList.add('active');
  const txt = this.innerText.trim().toLowerCase();
  if(txt === 'birthmonth'){ openOptionModal('birthmonth'); return; }
  if(txt === 'municipality'){ openOptionModal('municipality'); return; }
  applyFilters();
}));

/* ---------- Alphabet ---------- */
function buildAlphabet(){
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  alphabetContainer.innerHTML = '';
  const allBtn = document.createElement('button'); allBtn.type = 'button';
  allBtn.classList.add('active'); allBtn.innerText='All';
  allBtn.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(b=>b.classList.remove('active')); allBtn.classList.add('active'); selectedLetter = ''; applyFilters(); });
  alphabetContainer.appendChild(allBtn);
  letters.split('').forEach(l=>{
    const b = document.createElement('button'); b.type = 'button';
    b.innerText = l;
    b.addEventListener('click', ()=>{ document.querySelectorAll('#alphabetContainer button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); selectedLetter = l.toLowerCase(); applyFilters(); });
    alphabetContainer.appendChild(b);
  });
}

/* ---------- Populate selects (birthmonth integrated) ---------- */
function populateSelects(){
  function uniq(arr){ return [...new Set(arr.filter(x=>x !== undefined && x !== null && String(x).trim() !== ''))].sort(); }

  collegeCourseMap = {};
  allData.forEach(d=>{
    const col = d.college || d.campus || '';
    const crs = d.course || '';
    if(!col) return;
    const key = String(col).trim();
    if(!collegeCourseMap[key]) collegeCourseMap[key] = new Set();
    if(crs) collegeCourseMap[key].add(crs);
  });

  batchSelect.innerHTML = '<option value="">Select Batch</option>';
  collegeSelect.innerHTML = '<option value="">Select College</option>';
  courseSelect.innerHTML = '<option value="">Select Course</option>';
  municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
  birthmonthSelect.innerHTML = '<option value="">Select BirthMonth</option>';

  uniq(allData.map(d => d.batch)).forEach(v=> batchSelect.innerHTML += `<option>${v}</option>`);
  uniq(allData.map(d => d.college || d.campus)).forEach(v=> collegeSelect.innerHTML += `<option>${v}</option>`);
  uniq(allData.map(d => d.course)).forEach(v=> courseSelect.innerHTML += `<option>${v}</option>`);
  uniq(allData.map(d => d.municipality || d.city || '')).forEach(v=> municipalitySelect.innerHTML += `<option>${v}</option>`);

  // birthmonth: collect numeric months present and render Jan..Dec
  const monthsPresent = new Set();
  allData.forEach(d => {
    if(d.birthmonthNum) monthsPresent.add(Number(d.birthmonthNum));
  });
  const monthNums = Array.from(monthsPresent).sort((a,b)=>a-b);
  monthNums.forEach(num => {
    const name = monthNameFromNumber(num);
    birthmonthSelect.innerHTML += `<option value="${num}">${name}</option>`;
  });

  if(courseSelect.value && courseSelect.value !== '') courseSelect.style.display = '';
  else courseSelect.style.display = 'none';

  populateBatchDropdownMenu();
}

/* ---------- Batch dropdown (unchanged) ---------- */
function populateBatchDropdownMenu(){
  batchDropdownMenu.innerHTML = '';
  const batches = [...new Set(allData.map(d => d.batch).filter(x => x && x !== ''))].sort();
  const allOptBtn = document.createElement('button');
  allOptBtn.type = 'button';
  allOptBtn.innerText = 'All Batches';
  allOptBtn.addEventListener('click', ()=> {
    batchSelect.value = '';
    batchDropdownLabel.innerText = 'All Batches';
    closeBatchMenu();
    updateSelectActive(batchSelect);
    applyFilters();
  });
  batchDropdownMenu.appendChild(allOptBtn);

  batches.forEach(b => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.innerText = b;
    btn.addEventListener('click', ()=>{
      batchSelect.value = b;
      batchDropdownLabel.innerText = b;
      closeBatchMenu();
      updateSelectActive(batchSelect);
      applyFilters();
    });
    batchDropdownMenu.appendChild(btn);
  });

  const clearBtn = document.createElement('button');
  clearBtn.type = 'button';
  clearBtn.innerText = 'Clear Batch';
  clearBtn.style.marginTop = '8px';
  clearBtn.addEventListener('click', ()=> {
    batchSelect.value = '';
    batchDropdownLabel.innerText = 'All Batches';
    closeBatchMenu();
    updateSelectActive(batchSelect);
    applyFilters();
  });
  batchDropdownMenu.appendChild(clearBtn);
}
function openBatchMenu(){ batchDropdownMenu.style.display = 'block'; batchDropdownBtn.setAttribute('aria-expanded', 'true'); }
function closeBatchMenu(){ batchDropdownMenu.style.display = 'none'; batchDropdownBtn.setAttribute('aria-expanded', 'false'); }
batchDropdownBtn.addEventListener('click', (e)=> { e.stopPropagation(); const shown = batchDropdownMenu.style.display === 'block'; if(shown) closeBatchMenu(); else openBatchMenu(); });
document.addEventListener('click', (e)=>{ if(!document.getElementById('batchDropdownWrap').contains(e.target)){ closeBatchMenu(); } });

/* ---------- Course modal (unchanged) ---------- */
const courseListEl = document.getElementById('courseList');
const courseModal = document.getElementById('courseModal');
const courseFallback = document.getElementById('courseFallback');
document.getElementById('courseClearBtn').addEventListener('click', ()=>{
  courseSelect.value = '';
  courseSelect.style.display = 'none';
  closeModalAll();
  applyFilters();
  updateSelectActive(courseSelect);
});
function openCourseSelectionModal(collegeName){
  const set = collegeCourseMap[collegeName] || new Set();
  const arr = Array.from(set).sort();
  courseListEl.innerHTML = '';
  courseFallback.style.display = 'none';
  if(arr.length === 0){ courseFallback.style.display = ''; openModal('courseModal'); return; }
  if(arr.length === 1){
    courseSelect.innerHTML = `<option value="">Select Course</option><option selected>${arr[0]}</option>`;
    courseSelect.value = arr[0];
    courseSelect.style.display = '';
    applyFilters();
    courseListEl.innerHTML = `<button type="button" class="course-btn" data-course="${arr[0]}">${arr[0]}</button>`;
    courseListEl.querySelectorAll('.course-btn').forEach(b=>{ b.addEventListener('click', ()=> { courseSelect.value = b.dataset.course || ''; courseSelect.style.display = ''; closeModalAll(); updateSelectActive(courseSelect); applyFilters(); }); });
    openModal('courseModal');
    return;
  }
  arr.forEach(c => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'course-btn';
    b.dataset.course = c;
    b.innerText = c;
    b.addEventListener('click', ()=>{
      courseSelect.innerHTML = '<option value="">Select Course</option>';
      const opt = document.createElement('option');
      opt.value = c;
      opt.selected = true;
      opt.innerText = c;
      courseSelect.appendChild(opt);
      courseSelect.value = c;
      courseSelect.style.display = '';
      closeModalAll();
      updateSelectActive(courseSelect);
      applyFilters();
    });
    courseListEl.appendChild(b);
  });
  openModal('courseModal');
}

/* ---------- Generic Option Modal (Municipality / BirthMonth) ---------- */
let currentOptionField = ''; // 'municipality' or 'birthmonth'
optionClearBtn.addEventListener('click', ()=>{
  if(currentOptionField === 'municipality'){ municipalitySelect.value = ''; updateSelectActive(municipalitySelect); }
  else if(currentOptionField === 'birthmonth'){ birthmonthSelect.value = ''; updateSelectActive(birthmonthSelect); }
  closeModalAll();
  applyFilters();
});
function openOptionModal(field){
  currentOptionField = field;
  optionListEl.innerHTML = '';
  optionFallback.style.display = 'none';

  // add a quick "clear" button at top of list for convenience
  const clearTop = document.createElement('button');
  clearTop.type = 'button';
  clearTop.className = 'option-clear-top';
  clearTop.innerText = 'Clear selection';
  clearTop.addEventListener('click', ()=> {
    if(field === 'municipality'){
      municipalitySelect.value = '';
      updateSelectActive(municipalitySelect);
    } else if(field === 'birthmonth'){
      birthmonthSelect.value = '';
      updateSelectActive(birthmonthSelect);
    }
    closeModalAll();
    applyFilters();
  });

  if(field === 'municipality'){
    optionModalTitle.innerText = 'Select Municipality';
    optionModalDesc.innerText = 'Choose a municipality to filter by:';
    const vals = [...new Set(allData.map(d => String(d.municipality || d.city || '').trim()).filter(Boolean))].sort();
    if(vals.length === 0){ optionFallback.style.display = ''; openModal('optionModal'); return; }
    // append clearTop first, then values (clearTop visible and easy to reach)
    optionListEl.appendChild(clearTop);
    vals.forEach(v=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.innerText = v;
      b.addEventListener('click', ()=>{
        municipalitySelect.value = v;
        updateSelectActive(municipalitySelect);
        closeModalAll();
        applyFilters();
      });
      optionListEl.appendChild(b);
    });
    openModal('optionModal');
    return;
  }

  if(field === 'birthmonth'){
    optionModalTitle.innerText = 'Select Birth Month';
    optionModalDesc.innerText = 'Choose a birth month to filter by:';
    const monthNums = [...new Set(allData.map(d => d.birthmonthNum).filter(Boolean))].sort((a,b)=>a-b);
    if(monthNums.length === 0){ optionFallback.style.display = ''; openModal('optionModal'); return; }
    optionListEl.appendChild(clearTop);
    monthNums.forEach(n=>{
      const name = monthNameFromNumber(n);
      const b = document.createElement('button');
      b.type = 'button';
      b.innerText = name;
      b.addEventListener('click', ()=>{
        birthmonthSelect.value = String(n);
        updateSelectActive(birthmonthSelect);
        closeModalAll();
        applyFilters();
      });
      optionListEl.appendChild(b);
    });
    openModal('optionModal');
    return;
  }
}

/* ---------- Select active visuals ---------- */
function updateSelectActive(selectEl){ if(!selectEl) return; if(selectEl.value && selectEl.value !== '') selectEl.classList.add('active'); else selectEl.classList.remove('active'); }
function updateAllSelectActiveStates(){ [collegeSelect, courseSelect, batchSelect, municipalitySelect, birthmonthSelect, statusFilter].forEach(updateSelectActive); }

/* ---------- Reload / init ---------- */
async function reloadAll(){
  try {
    const raw = await fetchAllFromServer();
    allData = raw;
    allData.sort(compareNames);
    populateSelects();
    buildAlphabet();
    applyFilters();
  } catch(err){
    console.error('Reload failed', err);
    cardsContainer.innerHTML = `<p style="color:#a00">Unable to load alumni data. ${err.message || ''}</p>`;
  }
}

/* ---------- CSV Export (includes birthmonthNum & birthmonth) ---------- */
function escapeCSV(value){ if(value === null || value === undefined) return ''; const s = String(value); if(s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"'; return s; }
function exportToCSV(data){
  if(!Array.isArray(data)) data = [];
  const headers = ['_uid','firstname','middlename','surname','email','cpnumber','college','course','batch','designation','job','address','gender','birthday','municipality','birthmonth','birthmonthNum','_row'];
  const lines = [headers.join(',')];
  data.forEach(d=>{
    const row = headers.map(h => {
      if(h === 'birthmonthNum') return escapeCSV(d.birthmonthNum === undefined || d.birthmonthNum === null ? '' : d.birthmonthNum);
      if(h === 'municipality') return escapeCSV(d.municipality || '');
      return escapeCSV(d[h] === undefined ? '' : d[h]);
    });
    lines.push(row.join(','));
  });
  const csv = lines.join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `alumni_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
exportBtnTop.addEventListener('click', ()=>{ const dataToExport = Array.isArray(filteredData) && filteredData.length >= 0 ? filteredData : allData; exportToCSV(dataToExport); });

/* ---------- Init ---------- */
(function init(){ buildAlphabet(); reloadAll().catch(err => console.warn('Initial load error', err)); })();

</script>

</body>
</html>